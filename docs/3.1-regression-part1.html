<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Regression Part 1 (L3) – BIO144 Course Book (version 2026)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./4.1-regression-part2.html" rel="next">
<link href="./2.1-R-and-RStudio.html" rel="prev">
<link href="./cover.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-485d01fc63b59abcd3ee1bf1e8e2748d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./3.1-regression-part1.html">Regression Part 1 (L3)</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">BIO144 Course Book (version 2026)</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/opetchey/BIO144_Course_Book/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1.1-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction (L1)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2.1-R-and-RStudio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R and RStudio (L2)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3.1-regression-part1.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Regression Part 1 (L3)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./4.1-regression-part2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regression Part 2 (L4)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./5.1-anova.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analysis of variance (L5)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./6.1-multiple-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multiple regression (L6)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./7.1-interactions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interactions (L7)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./8.1-GLM1-count-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Count data (L8)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./9.1-GLM2-binary-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Binary data (L9)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10.1-ordination.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ordination (L10)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11.1-mixed-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mixed models (L11-1)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11.2-what-next.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">What next (L11-2)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12.1-review.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Review (L12)</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#why-use-linear-regression" id="toc-why-use-linear-regression" class="nav-link" data-scroll-target="#why-use-linear-regression">Why use linear regression?</a></li>
  <li><a href="#an-example---blood-pressure-and-age" id="toc-an-example---blood-pressure-and-age" class="nav-link" data-scroll-target="#an-example---blood-pressure-and-age">An example - blood pressure and age</a></li>
  </ul></li>
  <li><a href="#calculating-the-intercept-and-slope" id="toc-calculating-the-intercept-and-slope" class="nav-link" data-scroll-target="#calculating-the-intercept-and-slope">Calculating the intercept and slope</a>
  <ul class="collapse">
  <li><a href="#regression-from-a-mathematical-perspective" id="toc-regression-from-a-mathematical-perspective" class="nav-link" data-scroll-target="#regression-from-a-mathematical-perspective">Regression from a mathematical perspective</a></li>
  <li><a href="#finding-the-intercept-and-the-slope" id="toc-finding-the-intercept-and-the-slope" class="nav-link" data-scroll-target="#finding-the-intercept-and-the-slope">Finding the intercept and the slope</a></li>
  <li><a href="#least-squares" id="toc-least-squares" class="nav-link" data-scroll-target="#least-squares">Least squares</a></li>
  <li><a href="#least-squares-estimates" id="toc-least-squares-estimates" class="nav-link" data-scroll-target="#least-squares-estimates">Least squares estimates</a></li>
  <li><a href="#why-division-by-n-2-ensures-an-unbiased-estimator" id="toc-why-division-by-n-2-ensures-an-unbiased-estimator" class="nav-link" data-scroll-target="#why-division-by-n-2-ensures-an-unbiased-estimator">Why division by <span class="math inline">\(n-2\)</span> ensures an unbiased estimator</a></li>
  <li><a href="#lets-do-it-in-r" id="toc-lets-do-it-in-r" class="nav-link" data-scroll-target="#lets-do-it-in-r">Let’s do it in R</a></li>
  </ul></li>
  <li><a href="#dealing-with-the-error" id="toc-dealing-with-the-error" class="nav-link" data-scroll-target="#dealing-with-the-error">Dealing with the error</a>
  <ul class="collapse">
  <li><a href="#example-in-r" id="toc-example-in-r" class="nav-link" data-scroll-target="#example-in-r">Example in R</a></li>
  <li><a href="#back-to-blood-pressure-and-age" id="toc-back-to-blood-pressure-and-age" class="nav-link" data-scroll-target="#back-to-blood-pressure-and-age">Back to blood pressure and age</a></li>
  </ul></li>
  <li><a href="#is-the-model-good-enough-to-use" id="toc-is-the-model-good-enough-to-use" class="nav-link" data-scroll-target="#is-the-model-good-enough-to-use">Is the model good enough to use?</a>
  <ul class="collapse">
  <li><a href="#what-assumptions-do-we-make" id="toc-what-assumptions-do-we-make" class="nav-link" data-scroll-target="#what-assumptions-do-we-make">What assumptions do we make?</a></li>
  <li><a href="#a-normally-distributed-residuals" id="toc-a-normally-distributed-residuals" class="nav-link" data-scroll-target="#a-normally-distributed-residuals">(a) Normally distributed residuals</a></li>
  <li><a href="#a-normally-distributed-residuals-the-qq-plot" id="toc-a-normally-distributed-residuals-the-qq-plot" class="nav-link" data-scroll-target="#a-normally-distributed-residuals-the-qq-plot">(a) Normally distributed residuals: The QQ-plot</a></li>
  <li><a href="#b-constant-error-variance-homoscedasticity" id="toc-b-constant-error-variance-homoscedasticity" class="nav-link" data-scroll-target="#b-constant-error-variance-homoscedasticity">(b) Constant error variance (homoscedasticity)</a></li>
  <li><a href="#c-independence-residuals-are-independent-of-each-other" id="toc-c-independence-residuals-are-independent-of-each-other" class="nav-link" data-scroll-target="#c-independence-residuals-are-independent-of-each-other">(c) Independence (residuals are independent of each other)</a></li>
  <li><a href="#d-linearity-assumption" id="toc-d-linearity-assumption" class="nav-link" data-scroll-target="#d-linearity-assumption">(d) Linearity assumption</a></li>
  <li><a href="#e-no-outliers" id="toc-e-no-outliers" class="nav-link" data-scroll-target="#e-no-outliers">(e) No outliers</a></li>
  <li><a href="#the-autoplot-function-from-the-ggfortify-package" id="toc-the-autoplot-function-from-the-ggfortify-package" class="nav-link" data-scroll-target="#the-autoplot-function-from-the-ggfortify-package">The <code>autoplot()</code> function from the <code>ggfortify</code> package</a></li>
  </ul></li>
  <li><a href="#what-can-go-wrong-during-the-modeling-process" id="toc-what-can-go-wrong-during-the-modeling-process" class="nav-link" data-scroll-target="#what-can-go-wrong-during-the-modeling-process">What can go “wrong” during the modeling process?</a>
  <ul class="collapse">
  <li><a href="#what-to-do-when-things-go-wrong" id="toc-what-to-do-when-things-go-wrong" class="nav-link" data-scroll-target="#what-to-do-when-things-go-wrong">What to do when things “go wrong”?</a></li>
  <li><a href="#dealing-with-non-linearity" id="toc-dealing-with-non-linearity" class="nav-link" data-scroll-target="#dealing-with-non-linearity">Dealing with non-linearity</a></li>
  <li><a href="#common-transformations" id="toc-common-transformations" class="nav-link" data-scroll-target="#common-transformations">Common transformations</a></li>
  <li><a href="#outliers" id="toc-outliers" class="nav-link" data-scroll-target="#outliers">Outliers</a></li>
  <li><a href="#removing-outliers" id="toc-removing-outliers" class="nav-link" data-scroll-target="#removing-outliers">Removing outliers</a></li>
  </ul></li>
  <li><a href="#its-a-kind-of-magic" id="toc-its-a-kind-of-magic" class="nav-link" data-scroll-target="#its-a-kind-of-magic">Its a kind of magic…</a>
  <ul class="collapse">
  <li><a href="#so-what-is-a-linear-model" id="toc-so-what-is-a-linear-model" class="nav-link" data-scroll-target="#so-what-is-a-linear-model">So what is a linear model?</a></li>
  </ul></li>
  <li><a href="#review" id="toc-review" class="nav-link" data-scroll-target="#review">Review</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading">Further reading</a></li>
  <li><a href="#extras" id="toc-extras" class="nav-link" data-scroll-target="#extras">Extras</a>
  <ul class="collapse">
  <li><a href="#tests-for-normality" id="toc-tests-for-normality" class="nav-link" data-scroll-target="#tests-for-normality">Tests for normality</a></li>
  <li><a href="#more-insight-from-qq-plots" id="toc-more-insight-from-qq-plots" class="nav-link" data-scroll-target="#more-insight-from-qq-plots">More insight from QQ-plots</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/opetchey/BIO144_Course_Book/edit/main/3.1-regression-part1.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/opetchey/BIO144_Course_Book/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Regression Part 1 (L3)</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Linear regression is a common statistical method that models the relationship between a dependent (response) variable and one or more independent (explanatory) variables. The relationship is modeled with the equation for a straight line (<span class="math inline">\(y = a + bx\)</span>).</p>
<p>With linear regression we can answer questions such as:</p>
<ul>
<li>How does the dependent (response) variable change with respect to the independent (explanatory) variable?</li>
<li>What amount of variation in the dependent variable can be explained by the independent variable?</li>
<li>Is there a statistically significant relationship between the dependent variable and the independent variable?</li>
<li>Does the linear model fit the data well?</li>
</ul>
<p>In this chapter / lesson we will explore what is linear regression and how to use it to answer these questions. We’ll cover the following topics:</p>
<ul>
<li>Why use linear regression?</li>
<li>What is the linear regression model?</li>
<li>Fitting the regression model (= finding the intercept and the slope).</li>
<li>Is linear regression a good enough model to use?</li>
<li>What do we do when things go wrong?</li>
<li>Transformation of variables/the response.</li>
<li>Identifying and handling odd data points (aka outliers).</li>
</ul>
<p>In this chapter / lesson we will not discuss the statistical significance of the model. We will cover this topic in the next chapter / lesson.</p>
<section id="why-use-linear-regression" class="level3">
<h3 class="anchored" data-anchor-id="why-use-linear-regression">Why use linear regression?</h3>
<ul>
<li>It’s a good starting point because it is a relatively simple model.</li>
<li>Relationships are sometimes close enough to linear.</li>
<li>It’s easy to interpret.</li>
<li>It’s easy to use.</li>
<li>It’s actually quite flexible (e.g.&nbsp;can be used for non-linear relationships, e.g., a quadratic model is still a linear model!!!).</li>
</ul>
</section>
<section id="an-example---blood-pressure-and-age" class="level3">
<h3 class="anchored" data-anchor-id="an-example---blood-pressure-and-age">An example - blood pressure and age</h3>
<p>There are lots of situations in which linear regression can be useful. For example, consider hypertension. Hypertension is a condition in which the blood pressure in the arteries is persistently elevated. Hypertension is a major risk factor for heart disease, stroke, and kidney disease. It is estimated that hypertension affects about 1 billion people worldwide. Hypertension is a complex condition that is influenced by many factors, including age. In fact, it is well known that blood pressure increases with age. But how much does blood pressure increase with age? This is a question that can be answered using linear regression.</p>
<p>Here is an example of a study that used linear regression to answer this question: https://journals.lww.com/jhypertension/fulltext/2021/06000/association_of_age_and_blood_pressure_among_3_3.15.aspx</p>
<p>In this study, the authors used linear regression to model the relationship between age and blood pressure. They found that systolic blood pressure increased by 0.28–0.85 mmHg/year. This is a small increase, but it is statistically significant. This means that the observed relationship between age and blood pressure is unlikely to be due to chance.</p>
<p>Lets look at some simulated example data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>bp_age_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"datasets/Simulated_Blood_Pressure_and_Age_Data.csv"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># How many data points with both age and blood pressure?</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>bp_age_data <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(bp_age_data)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># No rows with missing values</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the data</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(bp_age_data, <span class="fu">aes</span>(<span class="at">x =</span> Age, <span class="at">y =</span> Systolic_BP)) <span class="sc">+</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Systolic Blood Pressure vs. Age"</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Age"</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Systolic Blood Pressure"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>Well, that is pretty conclusive. We hardly need statistics. There is a clear positive relationship between age and systolic blood pressure. But how can we quantify this relationship? And in less clear-cut cases what is the strength of evidence for a relationship? This is where linear regression comes in. Linear regression models the relationship between age and systolic blood pressure. With linear regression we can answer the following questions:</p>
<ul>
<li>What is the value of the intercept and slope of the relationship?</li>
<li>Is the relationship different from what we would expect if there were no relationship?</li>
<li>How well does the mathematical representation match the observed values?</li>
<li>How much uncertainty is there in predictions?</li>
</ul>
<p>Lets try to figure some of these out from the visualisation.</p>
<!---
**Think-Pair-Share** (#tps-guess-params) Make a guess of the slope. Make a guess of the intercept (hint be careful, lots of people get this wrong).
--->
</section>
</section>
<section id="calculating-the-intercept-and-slope" class="level2">
<h2 class="anchored" data-anchor-id="calculating-the-intercept-and-slope">Calculating the intercept and slope</h2>
<section id="regression-from-a-mathematical-perspective" class="level3">
<h3 class="anchored" data-anchor-id="regression-from-a-mathematical-perspective">Regression from a mathematical perspective</h3>
<p>Given an <strong>independent/explanatory variable</strong> (<span class="math inline">\(X\)</span>) and a <strong>dependent/response variable</strong> (<span class="math inline">\(Y\)</span>) all points <span class="math inline">\((x_i,y_i)\)</span>, <span class="math inline">\(i= 1,\ldots, n\)</span>, on a straight line follow the equation</p>
<p><span class="math display">\[y_i = \beta_0 + \beta_1 x_i\ .\]</span></p>
<ul>
<li><span class="math inline">\(\beta_0\)</span> is the <strong>intercept</strong> - the value of <span class="math inline">\(Y\)</span> when <span class="math inline">\(x_i = 0\)</span></li>
<li><span class="math inline">\(\beta_1\)</span> the <strong>slope</strong> of the line, also known as the regression coefficient of <span class="math inline">\(X\)</span>.</li>
<li>If <span class="math inline">\(\beta_0=0\)</span> the line goes through the origin <span class="math inline">\((x,y)=(0,0)\)</span>.</li>
<li><strong>Interpretation</strong> of linear dependency: proportional increase in <span class="math inline">\(y\)</span> with increase (decrease) in <span class="math inline">\(x\)</span>.</li>
</ul>
</section>
<section id="finding-the-intercept-and-the-slope" class="level3">
<h3 class="anchored" data-anchor-id="finding-the-intercept-and-the-slope">Finding the intercept and the slope</h3>
<p>In a regression analysis, one task is to estimate the intercept and the slope. These are known as the <strong>regression coefficients</strong> <span class="math inline">\(\beta_0\)</span>, <span class="math inline">\(\beta_1\)</span>.</p>
<ul>
<li><p><strong>Problem</strong>: For more than two points <span class="math inline">\((x_i,y_i)\)</span>, <span class="math inline">\(i=1,\ldots, n\)</span>, there is generally no perfectly fitting line.</p></li>
<li><p><strong>Aim:</strong> We want to estimate the parameters <span class="math inline">\((\beta_0,\beta_1)\)</span> of the <strong>best fitting</strong> line <span class="math inline">\(Y = \beta_0 + \beta_1 x\)</span>.</p></li>
<li><p><strong>Idea:</strong> Find the <strong>best fitting line</strong> by minimizing the deviations between the data points <span class="math inline">\((x_i,y_i)\)</span> and the regression line. I.e., minimising the residuals.</p></li>
</ul>
<p>But which deviations?</p>
<p>These ones?</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>Or these?</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>Or maybe even these?</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>Well, actually its none of these!!!</p>
</section>
<section id="least-squares" class="level3">
<h3 class="anchored" data-anchor-id="least-squares">Least squares</h3>
<p>For multiple reasons (theoretical aspects and mathematical convenience), the intercept and slope are estimated using the <strong>least squares</strong> approach. In this, yet something else is minimized:</p>
<p>The parameters <span class="math inline">\(\beta_0\)</span> and <span class="math inline">\(\beta_1\)</span> are estimated such that the <strong>sum of squared vertical distances</strong> (sum of squared residuals / errors) is minimised.</p>
<p><strong>SSE</strong> means <strong>S</strong>um of <strong>S</strong>quared <strong>E</strong>rrors:</p>
<p><span class="math display">\[SSE = \sum_{i=1}^n e_i^2 \]</span></p>
<p>where,</p>
<p><span class="math display">\[e_i = y_i - \underbrace{(\beta_0 + \beta_1 x_i)}_{=\hat{y}_i} \]</span> <strong>Note:</strong> <span class="math inline">\(\hat y_i = \beta_0 + \beta_1 x_i\)</span> are the <em>predicted values</em>.</p>
<p>In the graph just below, one of these squares is shown in red.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Residuals are model-based quantities, not properties of the raw data.</p>
</div>
</div>
</section>
<section id="least-squares-estimates" class="level3">
<h3 class="anchored" data-anchor-id="least-squares-estimates">Least squares estimates</h3>
<p>With a linear model, we can calculate the least squares estimates of the parameters <span class="math inline">\(\beta_0\)</span> and <span class="math inline">\(\beta_1\)</span> directly using the following formulas.</p>
<p>For a given sample of data <span class="math inline">\((x_i,y_i), i=1,..,n\)</span>, with mean values <span class="math inline">\(\overline{x}\)</span> and <span class="math inline">\(\overline{y}\)</span>, the least squares estimates <span class="math inline">\(\hat\beta_0\)</span> and <span class="math inline">\(\hat\beta_1\)</span> are computed as</p>
<p><span class="math display">\[ \hat\beta_1 = \frac{\sum_{i=1}^n  (y_i - \overline{y}) (x_i - \overline{x})}{ \sum_{i=1}^n (x_i - \overline{x})^2 } = \frac{cov(x,y)}{var(x)}\]</span></p>
<p><span class="math display">\[\hat\beta_0 = \overline{y} - \hat\beta_1 \overline{x}  \]</span></p>
<p>Moreover,</p>
<p><span class="math display">\[ \hat\sigma^2 = \frac{1}{n-2}\sum_{i=1}^n e_i^2 \quad \text{with residuals  } e_i = y_i - (\hat\beta_0 + \hat\beta_1 x_i) \]</span></p>
<p>is an unbiased estimate of the residual variance <span class="math inline">\(\sigma^2\)</span>.</p>
<p>(Derivations of the equations above are in the Stahel script 2.A b. Hint: differentiate, set to zero, solve.)</p>
</section>
<section id="why-division-by-n-2-ensures-an-unbiased-estimator" class="level3">
<h3 class="anchored" data-anchor-id="why-division-by-n-2-ensures-an-unbiased-estimator">Why division by <span class="math inline">\(n-2\)</span> ensures an unbiased estimator</h3>
<p>When estimating parameters (<span class="math inline">\(\beta_0\)</span> and <span class="math inline">\(\beta_1\)</span>), the square of the residuals is minimised. This fitting process inherently <em>uses up</em> two <em>degrees of freedom</em>, as the model forces the residuals to sum to zero and aligns the slope to best fit the data. I.e., one degree of freedom is lost due to the estimation of the intercept, and another due to the estimation of the slope.</p>
<p>The adjustment (division by <span class="math inline">\(n-2\)</span> instead of <span class="math inline">\(n\)</span>) compensates for the loss of variability due to parameter estimation, ensuring the estimator of the residual variance is unbiased. Mathematically, dividing by n - 2 adjusts for this loss and gives an accurate estimate of the population variance when working with sample data.</p>
<p>We’ll look at degrees of freedom in more detail later, so don’t worry if this is a bit confusing right now.</p>
</section>
<section id="lets-do-it-in-r" class="level3">
<h3 class="anchored" data-anchor-id="lets-do-it-in-r">Let’s do it in R</h3>
<p>First we read in the dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>bp_age_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"datasets/Simulated_Blood_Pressure_and_Age_Data.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The we make a graph of the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(bp_age_data, <span class="fu">aes</span>(<span class="at">x =</span> Age, <span class="at">y =</span> Systolic_BP)) <span class="sc">+</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Age (years)"</span>, <span class="at">y =</span> <span class="st">"Systolic Blood Pressure (mmHg)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>Then we make the linear model, using the <code>lm()</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>bp_age_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(Systolic_BP <span class="sc">~</span> Age, <span class="at">data =</span> bp_age_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we can look at the summary of the model. It contains a lot of information, so can be a bit confusing at first.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bp_age_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Systolic_BP ~ Age, data = bp_age_data)

Residuals:
     Min       1Q   Median       3Q      Max 
-13.2195  -3.4434  -0.0808   3.1383  12.6025 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 98.96874    1.46102   67.74   &lt;2e-16 ***
Age          0.82407    0.02771   29.74   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 4.971 on 98 degrees of freedom
Multiple R-squared:  0.9002,    Adjusted R-squared:  0.8992 
F-statistic: 884.4 on 1 and 98 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>How do our guesses of the intercept and slope compare to the guesses we made earlier?</p>
<p>Recal that the units of the <em>Age</em> coefficient are in mmHg per year. This means that for each additional year of age, the systolic blood pressure increases by ´r round(coef(bp_age_model)[2],2)´ mmHg.</p>
<!---
**Think–Pair–Share** (#a_interpreting_slope) In words, what does the slope represent in this model? What does it *not* tell you?
--->
</section>
</section>
<section id="dealing-with-the-error" class="level2">
<h2 class="anchored" data-anchor-id="dealing-with-the-error">Dealing with the error</h2>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>The line is not a perfect fit to the data. There is scatter around the line.</p>
<p>Some of this scatter could be caused by other factors that influence blood pressure, such as diet, exercise, and genetics. Also, the there could be differences due to the measurement instrument (i.e., some measurement error).</p>
<p>These other factors are not included in the model (only age is in the model), so they create variation that can only appear in error term.</p>
<p>In the linear regression model the dependent variable <span class="math inline">\(Y\)</span> is related to the independent variable <span class="math inline">\(x\)</span> as</p>
<p><span class="math display">\[Y = \beta_0 + \beta_1 x + \epsilon \ \]</span> where</p>
<ul>
<li><span class="math inline">\(\epsilon\)</span> is the error term</li>
<li><span class="math inline">\(\beta_0\)</span> is the intercept</li>
<li><span class="math inline">\(\beta_1\)</span> is the slope</li>
<li><span class="math inline">\(\epsilon\)</span> is the error term.</li>
</ul>
<p>The error term captures the difference between the observed value of the dependent variable and the value predicted by the model. The error term includes the effects of other factors that influence the dependent variable, as well as measurement error.</p>
<p><span class="math display">\[Y \quad= \quad \underbrace{\text{expected value}}_{E(Y) = \beta_0 + \beta_1 x} \quad + \quad \underbrace{\text{random error}}_{\epsilon}  \ .\]</span></p>
<p>Graphically the error term is the vertical distance between the observed value of the dependent variable and the value predicted by the model.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>The error term is also known as the residual. It is the variation that <em>resides</em> (is left over / is left unexplained) after accounting for the relationship between the dependent and independent variables.</p>
<section id="example-in-r" class="level3">
<h3 class="anchored" data-anchor-id="example-in-r">Example in R</h3>
<p>Let’s look at observed values, expected (predicted) values, and residuals (error) in R.</p>
<p>The observed values of the response (dependent) variable are already in the dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(bp_age_data<span class="sc">$</span>Systolic_BP)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 150.3277 170.0801 139.7174 135.4089 151.9041 122.0296</code></pre>
</div>
</div>
<p>To get the expected values, we need to find the intercept and slope of the linear model. We can do this using the <code>lm()</code> function in R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(Systolic_BP <span class="sc">~</span> Age, <span class="at">data =</span> bp_age_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And we can get the intercept and slope using the <code>coef()</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(lm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)         Age 
 98.9687381   0.8240678 </code></pre>
</div>
</div>
<p>We can then use the mutate function from the dplyr package to add the expected values to the dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>bp_age_data <span class="ot">&lt;-</span> bp_age_data <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Expected_BP =</span> <span class="fu">coef</span>(lm1)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">coef</span>(lm1)[<span class="dv">2</span>] <span class="sc">*</span> Age)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And we can get the residuals by subtracting the expected values from the observed values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>bp_age_data <span class="ot">&lt;-</span> bp_age_data <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Residuals =</span> Systolic_BP <span class="sc">-</span> Expected_BP)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>We can also get the expected values and residuals directly from the <code>lm</code> object using the <code>fitted()</code> (or <code>predicted()</code>) and <code>residuals()</code> functions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>bp_age_data <span class="ot">&lt;-</span> bp_age_data <span class="sc">%&gt;%</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Expected_BP =</span> <span class="fu">fitted</span>(lm1),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">Residuals =</span> <span class="fu">residuals</span>(lm1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>Now we have a model that gives the expected values (on the regression line) and that gives us a residual. Because the expected value plus the residual equals the observed value, if we use each of the residuals as the error for each respective data point, we end up with a perfect fit to the data. All we are doing is describing the observed data in a different way. This is known as over-fitting. In fact, we have gained very little by fitting the model. We have simply memorized / copied the data!!!</p>
<p>In order to avoid this, we need to assume something about the residuals – we need to <em>model</em> the residuals. The most common model for the residuals is a normal distribution with mean 0 and constant variance.</p>
<p><span class="math display">\[\epsilon \sim N(0,\sigma^2)\]</span></p>
<p><strong>This is known as the normality assumption.</strong> The normality assumption is important because it allows us to make inferences about the <em>population parameters</em> based on the <em>sample data</em>.</p>
<p>The linear regression model then becomes:</p>
<p><span class="math display">\[Y = \beta_0 + \beta_1 x + N(0,\sigma^2) \ \]</span></p>
<p>where <span class="math inline">\(\sigma^2\)</span> is the variance of the error term. The variance of the error term is the amount of variation in the dependent variable that is not explained by the independent variable. The variance of the error term is also known as the residual variance.</p>
<p>An alternate and equivalent formulation is that <span class="math inline">\(Y\)</span> is a random variable that follows a normal distribution with mean <span class="math inline">\(\beta_0 + \beta_1 x\)</span> and variance <span class="math inline">\(\sigma^2\)</span>.</p>
<p><span class="math display">\[Y \sim N(\beta_0 + \beta_1 x, \sigma^2)\]</span></p>
<p>So, the answer to the question “how do we deal with the error term” is that we model the error term as normally distributed with mean 0 and constant variance. Put another way, the error term is assumed to be normally distributed with mean 0 and constant variance.</p>
</section>
<section id="back-to-blood-pressure-and-age" class="level3">
<h3 class="anchored" data-anchor-id="back-to-blood-pressure-and-age">Back to blood pressure and age</h3>
<p>The mathematical model in this case is:</p>
<p><span class="math display">\[SystolicBP = \beta_0 + \beta_1 \times Age + \epsilon\]</span></p>
<p>where: <em>SystolicBP</em> is the dependent (response) variable, <span class="math inline">\(\beta_0\)</span> is the intercept, <span class="math inline">\(\beta_1\)</span> is the coefficient of Age, <em>Age</em> is the independent (explanatory) variable, <span class="math inline">\(\epsilon\)</span> is the error term.</p>
<p>Let’s ensure we understand this, by thinking about the units of the variables in this model. This can be very useful because it can help us to understand the model better and to check that the model makes sense.</p>
<!---
**Think-Pair-Share** (#tps-what-units)

* What are the units of blood pressure?
* What are the units of age?
* What are the units of the intercept?
* What are the units of the coefficient of Age?
* What are the units of the error term?
--->
</section>
</section>
<section id="is-the-model-good-enough-to-use" class="level2">
<h2 class="anchored" data-anchor-id="is-the-model-good-enough-to-use">Is the model good enough to use?</h2>
<ul>
<li>All models are wrong, but is ours good enough to be useful?</li>
<li>Are the assumption of the model justified?</li>
<li>It would be very unwise to use the model before we know if it is good enough to use.</li>
<li><em>Don’t jump out of an aeroplane until you know your parachute is good enough!</em></li>
</ul>
<section id="what-assumptions-do-we-make" class="level3">
<h3 class="anchored" data-anchor-id="what-assumptions-do-we-make">What assumptions do we make?</h3>
<p>We already heard about one. We assume that the residuals follow a <span class="math inline">\(N(0,\sigma^2)\)</span> distribution (that is, a Gaussian / Normal distrution with mean of zero and variance of <span class="math inline">\(\sigma^2\)</span>). We make this assumption because it is often well enough met, and it gives great mathematical tractability.</p>
<p>This assumption implies that:</p>
<ol type="a">
<li>The <span class="math inline">\(\epsilon_i\)</span> are normally distributed.</li>
<li><span class="math inline">\(\epsilon_i\)</span> has constant variance: <span class="math inline">\(Var(\epsilon_i)=\sigma^2\)</span>.</li>
<li>The <span class="math inline">\(\epsilon_i\)</span> are independent of each other.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>These assumptions are about the residuals, not the observed data!!!</p>
</div>
</div>
<p>Furthermore:</p>
<ol start="4" type="a">
<li>we assumed a linear relationship.</li>
<li>implies there are no outliers (implied by (a) above)</li>
</ol>
<p>Lets go through each five assumptions.</p>
</section>
<section id="a-normally-distributed-residuals" class="level3">
<h3 class="anchored" data-anchor-id="a-normally-distributed-residuals">(a) Normally distributed residuals</h3>
<p>Recall that we make the assumption that the residuals are normally distributed with mean 0 and constant variance:</p>
<p><span class="math display">\[\epsilon \sim N(0,\sigma^2)\]</span></p>
<p>Here we are concerned with the first part of this assumption, that the residuals are normally distributed.</p>
<p>What does this mean? How can we check it?</p>
<p>A normal distribution is symmetric and bell-shaped…</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>Lets look at the frequency distribution of the residuals of the linear regression of blood pressure and age:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>The normal distribution assumption (a) seems ok as well.</p>
</section>
<section id="a-normally-distributed-residuals-the-qq-plot" class="level3">
<h3 class="anchored" data-anchor-id="a-normally-distributed-residuals-the-qq-plot">(a) Normally distributed residuals: The QQ-plot</h3>
<p>Usually, not the histogram of the residuals is plotted, but the so-called <strong>quantile-quantile</strong> (QQ) plot. The quantiles of the observed distribution are plotted against the quantiles of the respective theoretical (normal) distribution:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(<span class="fu">residuals</span>(bp_age_model))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(<span class="fu">residuals</span>(bp_age_model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>If the points lie approximately on a straight line, the data is fairly normally distributed.</p>
<p>This is often “tested” by eye, and needs some experience.</p>
<p><em>But what on earth is a quantile???</em></p>
<p>Imagine we make 21 measures of something, say 21 blood pressures:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>The median of these is 127.8. The median is the 50% or 0.5 quantile, because half the data points are above it, and half below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(dd<span class="sc">$</span>Blood_Pressure, <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  50% 
127.8 </code></pre>
</div>
</div>
<p>The <em>theoretical quantiles</em> come from the normal distribution. The <em>sample quantiles</em> come from the distribution of our residuals.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<section id="how-do-i-know-if-a-qq-plot-looks-good" class="level4">
<h4 class="anchored" data-anchor-id="how-do-i-know-if-a-qq-plot-looks-good">How do I know if a QQ-plot looks “good”?</h4>
<p>There is <strong>no quantitative rule</strong> to answer this question. Instead experience is needed. You can gain this experience from simulations. To this end, we can generate the same number of data points of a normally distributed variable and compare this simulated qqplot to our observed one.</p>
<p>Example: Generate 100 points <span class="math inline">\(\epsilon_i \sim N(0,1)\)</span> each time:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>Each of the graphs above has data points that are randomly generated from a normal distribution. In all cases the data points are close to the line. This is what we would expect if the data were normally distributed. The amount of deviation from the line is what we would expect from random variation, and so seeing this amount of variation in a QQ-plot of your model should not be cause for concern.</p>
</section>
</section>
<section id="b-constant-error-variance-homoscedasticity" class="level3">
<h3 class="anchored" data-anchor-id="b-constant-error-variance-homoscedasticity">(b) Constant error variance (homoscedasticity)</h3>
<p>Recall that we assume the errors are normally distributed with constant variance <span class="math inline">\(\sigma^2\)</span>:</p>
<p><span class="math display">\[\epsilon_i \sim N(0, \sigma^2)\]</span></p>
<p>Here we’re concerned with the second part of this assumption, that the variance is constant.That is, variance of the residuals is a constant: <span class="math inline">\(\text{Var}(\epsilon_i) = \sigma^2\)</span>. And not, for example <span class="math inline">\(\text{Var}(\epsilon_i) = \sigma^2 \cdot x_i\)</span>.</p>
<p>Put another way, we’re interested if the size of the residuals tends to show a pattern with the fitted values. By <em>size</em> of the residuals we mean the <em>absolute value</em> of the residuals. In fact, we often look at the square root of the absolute value of the standardized residuals:</p>
<p><span class="math display">\[R_i = \frac{\epsilon_i}{\hat{\sigma}}\]</span> Where <span class="math inline">\(\hat{\sigma}\)</span> is the estimated standard deviation of the residuals:</p>
<p><span class="math display">\[\hat{\sigma} = \sqrt{\frac{1}{n-2} \sum_{i=1}^n \epsilon_i^2}\]</span></p>
<p>So that the full equation of the square root of the standardised residuals is:</p>
<p><span class="math display">\[\sqrt{|R_i|} = \sqrt{\left|\frac{\epsilon_i}{\hat{\sigma}}\right|}\]</span></p>
<p>To look to see if the variance of the residuals is constant, we need to see if there is any relationship between the size of the residuals and the fitted values. A commonly used visualistion for this is a plot of the size of the residuals against the fitted values.</p>
<p>Lets first calculated the <span class="math inline">\(\sqrt{|R_i|}\)</span> values for our blood pressure model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>bp_age_data <span class="ot">&lt;-</span> bp_age_data <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fitted =</span> <span class="fu">predict</span>(bp_age_model),</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">residuals =</span> <span class="fu">residuals</span>(bp_age_model),</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">sigma_hat =</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(residuals<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span>(<span class="fu">n</span>()<span class="sc">-</span><span class="dv">2</span>)),</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">R_i =</span> residuals <span class="sc">/</span> sigma_hat,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">sqrt_abs_R_i =</span> <span class="fu">sqrt</span>(<span class="fu">abs</span>(R_i)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now visualise the relationship between the fitted values and the size of the residuals:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(bp_age_data, <span class="fu">aes</span>(<span class="at">x =</span> fitted, <span class="at">y =</span> sqrt_abs_R_i)) <span class="sc">+</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Fitted values"</span>, <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">sqrt</span>(<span class="fu">abs</span>(R[i])))) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>This graph is known as the scale-location plot. It is particularly suited to check the assumption of equal variances (<strong>homoscedasticity / Homoskedastizität</strong>). There should be <strong>no trend</strong> or pattern.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>We can also use the built-in plot function for linear models to create this plot. It is the third plot in the set of model checking plots.</p>
<div class="cell" data-evaluate="false">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(bp_age_model, <span class="at">which=</span><span class="dv">3</span>, <span class="at">add.smooth =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
<section id="how-it-looks-with-the-variance-increasing-with-the-fitted-values" class="level4">
<h4 class="anchored" data-anchor-id="how-it-looks-with-the-variance-increasing-with-the-fitted-values">How it looks with the variance increasing with the fitted values</h4>
<p>Here’s a graphical example of how it would look if the variance of the residuals increases with the fitted values.</p>
<p>First here is a graph of the relationship:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">100</span>, <span class="dv">1</span>, <span class="dv">10</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="sc">+</span> <span class="dv">5</span><span class="sc">*</span>x <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>x<span class="sc">*</span><span class="fu">rnorm</span>(<span class="dv">100</span>,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">x=</span>x,<span class="at">y=</span>y), <span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>y)) <span class="sc">+</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">method=</span><span class="st">"lm"</span>, <span class="at">se=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>And here the scale-location plot for a linear model of that data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lm</span>(y<span class="sc">~</span>x)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m,<span class="at">which=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="c-independence-residuals-are-independent-of-each-other" class="level3">
<h3 class="anchored" data-anchor-id="c-independence-residuals-are-independent-of-each-other">(c) Independence (residuals are independent of each other)</h3>
<p>We assume that the residuals (<span class="math inline">\(\epsilon_i\)</span>) are independent of each other. This means that the value of one residual is not somehow related to the value of another.</p>
<p>The dataset about blood pressure we looked at contained 100 observations, each one made from a different person. In such a study design, we could be safe in the assumption that the people are independent, and therefore the assumption that the residuals are independent.</p>
<p>Imagine, however, if we had 100 observations of blood pressure collected from 50 people, because we measured the blood pressure of each person twice. In this case, the residuals would not be independent, because two measures of the blood pressure of the same person are likely to be similar. A person is likely to have a high blood pressure in both measurements, or a low blood pressure in both measurements. This would mean they have a high residual in both measurements, or a low residual in both measurements.</p>
<p>In this case, we would need to account for the fact that the residuals are not independent. We would need to use a more complex model, such as a mixed effects model, to account for the fact that the residuals are not independent. We will talk about this again in the last week of this course.</p>
<p>In general, you should always think about the study design when you are analysing data. You should always think about whether the residuals are likely to be independent of each other. If they are not, you should think about how you can account for this in your analysis.</p>
<p>A good way to assess if there could be dependencies in the residuals is to be critical about what is the unit of observation in the data. In the blood pressure example, the unit of observation is the person. Count the number of persons in the study. If there are fewer persons than observations, then at least some people must have been measured at least twice. Repeating measures on the same person is a common way to get dependent residuals.</p>
<p>So, to check the assumption of independence, you should:</p>
<ul>
<li>Think carefully about the study design.</li>
<li>Think carefully about the unit of observation in the data.</li>
<li>Compare the number of observations to the number of units of observation.</li>
</ul>
</section>
<section id="d-linearity-assumption" class="level3">
<h3 class="anchored" data-anchor-id="d-linearity-assumption">(d) Linearity assumption</h3>
<p>The linearity assumption states that the relationship between the independent variable and the dependent variable is linear. This means that the dependent variable changes by a constant amount for a one-unit change in the independent variable. And that this slope is does not change with the value of the independent variable.</p>
<p>The blood pressure data seems to be linear:</p>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `fortify(&lt;lm&gt;)` was deprecated in ggplot2 3.6.0.
ℹ Please use `broom::augment(&lt;lm&gt;)` instead.
ℹ The deprecated feature was likely used in the ggplot2 package.
  Please report the issue at &lt;https://github.com/tidyverse/ggplot2/issues&gt;.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(bp_age_model, <span class="fu">aes</span>(<span class="at">x =</span> Age, <span class="at">y=</span>Systolic_BP)) <span class="sc">+</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">method=</span><span class="st">"lm"</span>, <span class="at">se=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In contrast, look at this linear regression through data that appears non-linear:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">100</span>, <span class="dv">1</span>, <span class="dv">10</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>x <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">100</span>,<span class="dv">0</span>,<span class="dv">2</span>) <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span>x<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lm</span>(y<span class="sc">~</span>x)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">x=</span>x,<span class="at">y=</span>y), <span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>y)) <span class="sc">+</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">method=</span><span class="st">"lm"</span>, <span class="at">se=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>And with the residuals shown as red lines:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">x=</span>x,<span class="at">y=</span>y), <span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>y)) <span class="sc">+</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">method=</span><span class="st">"lm"</span>, <span class="at">se=</span><span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">xend=</span>x, <span class="at">yend=</span>m<span class="sc">$</span>fitted), <span class="at">color=</span><span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>At low values of <span class="math inline">\(y\)</span>, the residuals are positive, at intermediate values of <span class="math inline">\(y\)</span> the residuals are negative, and at high values of <span class="math inline">\(y\)</span> the residuals are positive. This pattern in the residuals is a sign that the relationship between <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> is not linear.</p>
<p>We can plot the value of the residuals against the <span class="math inline">\(y\)</span> value directly, instead of looking at the pattern in the graph above. This is called a <strong>Tukey-Anscombe plot</strong>. It is a graph of the residuals versus the fitted <span class="math inline">\(y\)</span> values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">fitted</span>(m), <span class="at">y =</span> <span class="fu">resid</span>(m))) <span class="sc">+</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype=</span><span class="st">"dashed"</span>, <span class="at">color=</span><span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>We can very clearly see pattern in the residuals in this Tukey-Anscombe plot. The residuals are positive, then negative, then positive, as the fitted <span class="math inline">\(y\)</span> value gets larger.</p>
<p>We can also make this Tukey-Anscombe plot using the built-in plot function for linear models in R:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m, <span class="at">which=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>The red line in the Tukey-Anscombe plot is a loess smooth. It is automatically added to the plot. It is a way of estimating the pattern in the residuals. If the red line is not flat, then there is a pattern in the residuals. However, the loess smooth is not always reliable. It is a good idea to look at the residuals directly, without this smooth.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m, <span class="at">which=</span><span class="dv">1</span>, <span class="at">add.smooth =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>The data here is simulated to show a very clear pattern in the residuals. In real data, the pattern might not be so clear. But if you suspect you see a pattern in the residuals, it could be a sign that the relationship between the independent and dependent variable is not linear.</p>
<p>Here is the Tukey-Anscombe plot for the blood pressure data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(bp_age_model, <span class="at">which=</span><span class="dv">1</span>, <span class="at">add.smooth =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>There is very little evidence of any pattern in the residuals. This data is simulated with a truly linear relationship, so we would not expect to see any pattern in the residuals.</p>
</section>
<section id="e-no-outliers" class="level3">
<h3 class="anchored" data-anchor-id="e-no-outliers">(e) No outliers</h3>
<p>An outlier is a data point that is very different from the other data points. Outliers can have a big effect on the results of a regression analysis. They can pull the line of best fit towards them, and make the line of best fit a poor representation of the data.</p>
<p>Lets again look at the blood pressure versus age data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(bp_age_model, <span class="fu">aes</span>(<span class="at">x =</span> Age, <span class="at">y=</span>Systolic_BP)) <span class="sc">+</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">method=</span><span class="st">"lm"</span>, <span class="at">se=</span><span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">10</span>, <span class="dv">85</span>) <span class="sc">+</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">100</span>, <span class="dv">180</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>There are no obvious outliers in this data. The data points are all close to the line of best fit. This is a good sign that the line of best fit is a good representation of the data.</p>
<!---
**Think-Pair-Share** (#tps-odd-data) Where on this graph would you expect to see particularly influential outliers? Influential in the sense that they would have a large effect on the slope of the line of best fit.
--->
<p>Data points that are far from the mean of the independent variable have a large effect on the value of the slope. These data points have a large leverage. They are data points that are far from the other data points in the <span class="math inline">\(x\)</span> direction.</p>
<p>We can think of this with the analogy of a seesaw. The slope of the line of best fit is like the pivot point of a seesaw. Data points that are far from the pivot point have a large effect on the slope. Data points that are close to the pivot point have a small effect on the slope.</p>
<p>A measure of distance from the pivot point is called the <span class="math inline">\(leverage\)</span> of a data point. In simple regression, the leverage of individual <span class="math inline">\(i\)</span> is defined as</p>
<p><span class="math inline">\(h_{i} = (1/n) + (x_i-\overline{x})^2 / SSX\)</span>.</p>
<p>where <span class="math inline">\(SSX = \sum_{i=1}^n (x_i - \overline{x})^2\)</span>. (<strong>S</strong>um of <strong>S</strong>quares of <strong><span class="math inline">\(X\)</span></strong>)</p>
<p>So, the leverage of a data point is inversely related to <span class="math inline">\(n\)</span> (the number of data points). The leverage of a data point is also inversely related to the sum of the squares of the <span class="math inline">\(x\)</span> values. The leverage of a data point is directly related to the square of the distance of the <span class="math inline">\(x\)</span> value from the mean of the <span class="math inline">\(x\)</span> values.</p>
<p>More intuitively perhaps, the leverage of a data point will be greater when the are fewer other data points. It will also be greater when the distance from the mean value of <span class="math inline">\(x\)</span> is greater.</p>
<p>Going back to the analogy of a seesaw, with data points as children on the seesaw, the leverage of a data point is like the distance from the pivot a child sits. But we also have children of different weights. A lighter child will have less effect on the tilt of the seesaw. A heavier one will have a greater effect on the tilt. A heavier child sitting far from the pivot will have a very large effect.</p>
<!---
**Think-Pair-Share** (#tps-like-weight) What quantity that we already experienced is like the weight of the child?
--->
<p>The size of the residuals are like the weight of the child. Data points with large residuals have a large effect on the slope of the line of best fit. Data points with small residuals have a small effect on the slope of the line of best fit.</p>
<p>So the overall effect of a data point on the slope of the line of best fit is a combination of the leverage and the residual. This quantity is called the <span class="math inline">\(influence\)</span> of a data point.</p>
<p>Let’s add a rather extreme data point to the blood pressure versus age data:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>This is a bit ridiculous, but it is a good example of an outlier. The data point is far from the other data points. It has a large residual. And it is a long way from the pivot (the middle of the <span class="math inline">\(x\)</span> data) so has large leverage.</p>
<p>We can make a histogram of the residuals and see that the outlier has a large residual:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>And we can see that the leverage is large.</p>
<p>There is a graph that we can look at to see the influence of a data point. This is called a <span class="math inline">\(Cook's\)</span> <span class="math inline">\(distance\)</span> plot. The Cook’s distance of a data point is a measure of how much the slope of the line of best fit changes when that data point is removed. The Cook’s distance of a data point is defined as</p>
<p><span class="math inline">\(D_i = \sum_{j=1}^n (\hat{y}_j - \hat{y}_{j(i)})^2 / (p \times MSE)\)</span>.</p>
<p>where <span class="math inline">\(\hat{y}_j\)</span> is the predicted value of the dependent variable for data point <span class="math inline">\(j\)</span>, <span class="math inline">\(\hat{y}_{j(i)}\)</span> is the predicted value of the dependent variable for data point <span class="math inline">\(j\)</span> when data point <span class="math inline">\(i\)</span> is removed, <span class="math inline">\(p\)</span> is the number of parameters in the model (2 in this case), <span class="math inline">\(MSE\)</span> is the mean squared error of the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(bp_age_model_outlier, <span class="at">which=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>But does it have a large influence on the value of the slope? In the next graph we show the line of best fit with the outlier (blue line) and without the outlier (red line).</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>No, the outlier doesn’t have much influence on the slope. The outlier has a large leverage. It is far from the pivot. But it does not have such a large effect (influence) on the slope. This is in large part because there are a lot data points (100) that are quite tightly arranged around the regression line.</p>
<section id="graphical-illustration-of-the-leverage-effect" class="level4">
<h4 class="anchored" data-anchor-id="graphical-illustration-of-the-leverage-effect">Graphical illustration of the leverage effect</h4>
<p>Data points with <span class="math inline">\(x_i\)</span> values far from the mean have a stronger leverage effect than when <span class="math inline">\(x_i\approx \overline{x}\)</span>:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>The outlier (red circle) in the middle plot “pulls” the regression line in its direction and has large influence on the slope. THe outlier (red circle) in the right plot has less influence on the slope because it is closer to the mean of <span class="math inline">\(x\)</span>.</p>
</section>
<section id="leverage-plot-hebelarm-diagramm" class="level4">
<h4 class="anchored" data-anchor-id="leverage-plot-hebelarm-diagramm">Leverage plot (Hebelarm-Diagramm)</h4>
<p>In the leverage plot, (standardized) residuals <span class="math inline">\(\tilde{R_i}\)</span> are plotted against the leverage <span class="math inline">\(H_{ii}\)</span> :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(bp_age_model, <span class="at">which=</span><span class="dv">5</span>, <span class="at">add.smooth =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>Critical ranges are the top and bottom right corners!!</p>
<p>Here, observations 71, 85, and 87 are labelled as potential outliers.</p>
<p>Some texts will give a rule of thumb that points with Cook’s distances greater than 1 should be considered influential, while others claim a reasonable rule of thumb is <span class="math inline">\(4 / ( n - p - 1 )\)</span> where <span class="math inline">\(n\)</span> is the sample size, and <span class="math inline">\(p\)</span> is the number of <span class="math inline">\(beta\)</span> parameters.</p>
<!---
**Think–Pair–Share** (#a_linear_model_assumptions) Which assumption of linear regression feels most fragile in real biological data? Why?
--->
</section>
</section>
<section id="the-autoplot-function-from-the-ggfortify-package" class="level3">
<h3 class="anchored" data-anchor-id="the-autoplot-function-from-the-ggfortify-package">The <code>autoplot()</code> function from the <code>ggfortify</code> package</h3>
<p>So far we have used the built-in <code>plot()</code> function for linear models to create the model checking plots. Another option is to use the <code>autoplot()</code> function from the <code>ggfortify</code> package. This function creates the same four model checking plots, but doesn’t require the <code>par(mfrow=c(2,2))</code> command to arrange the plots in a 2x2 grid, so is slightly more convenient to use. Of course, you do need to ensure that the <code>ggfortify</code> package is installed and loaded.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggfortify)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(bp_age_model, <span class="at">smooth.colour =</span> <span class="cn">NA</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>(At the time of writing, this use of <code>autoplot()</code> causes a warning message to be printed. This is a known issue with the <code>ggfortify</code> package. You can safely ignore this warning message for now.)</p>
</section>
</section>
<section id="what-can-go-wrong-during-the-modeling-process" class="level2">
<h2 class="anchored" data-anchor-id="what-can-go-wrong-during-the-modeling-process">What can go “wrong” during the modeling process?</h2>
<p>Answer: a lot of things!</p>
<ul>
<li>Non-linearity. We assumed a linear relationship between the response and the explanatory variables. But this is not always the case in practice. We might find that the relationship is curved and not well represtented by a straight line.</li>
<li>Non-normal distribution of residuals. The QQ-plot data might deviate from the straight line so much that we get worried!</li>
<li>Heteroscadisticity (non-constant variance). We assumed homoscadisticity, but the residuals might show a pattern.</li>
<li>Data point with high influence. We might have a data point that has a large influence on the slope of the line of best fit.</li>
</ul>
<section id="what-to-do-when-things-go-wrong" class="level3">
<h3 class="anchored" data-anchor-id="what-to-do-when-things-go-wrong">What to do when things “go wrong”?</h3>
<ol type="1">
<li>Now: Transform the response and/or explanatory variables.</li>
<li>Now: Take care of outliers.</li>
<li>Later in the course: Improve the model, e.g., by adding additional terms or interactions.</li>
<li>Later in the course: Use another model family (generalized or nonlinear regression model).</li>
</ol>
</section>
<section id="dealing-with-non-linearity" class="level3">
<h3 class="anchored" data-anchor-id="dealing-with-non-linearity">Dealing with non-linearity</h3>
<p>Here’s another example of <span class="math inline">\(y\)</span> and <span class="math inline">\(x\)</span> that are not linearly related:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>eg_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">runif</span>(<span class="dv">50</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_y =</span> <span class="fu">log</span>(<span class="fl">0.1</span>) <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span> <span class="fu">log</span>(x) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">50</span>,<span class="dv">0</span>,<span class="fl">0.1</span>),</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">exp</span>(log_y),</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_y =</span> <span class="fu">log</span>(y),</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_x =</span> <span class="fu">log</span>(x),</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">sqrt_y =</span> <span class="fu">sqrt</span>(y))</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(eg_data, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x, eg_data)</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">fitted</span>(m1), <span class="at">y =</span> <span class="fu">residuals</span>(m1))) <span class="sc">+</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">method =</span> <span class="st">"loess"</span>)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>One way to deal with this is to transform the response variable <span class="math inline">\(Y\)</span>. Here we try two different transformations: <span class="math inline">\(\log_{10}(Y)\)</span> and <span class="math inline">\(\sqrt{Y}\)</span>.</p>
<p>Square root transform of the response variable <span class="math inline">\(Y\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(eg_data, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> sqrt_y)) <span class="sc">+</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(sqrt_y <span class="sc">~</span> x, eg_data)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">fitted</span>(m2), <span class="at">y =</span> <span class="fu">residuals</span>(m2))) <span class="sc">+</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">method =</span> <span class="st">"loess"</span>)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">+</span> p2) <span class="sc">/</span> (p3 <span class="sc">+</span> p4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Not great.</p>
<p>Log transformation of the response variable <span class="math inline">\(Y\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(eg_data, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> log_y)) <span class="sc">+</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(log_y <span class="sc">~</span> x, eg_data)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>p6 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">fitted</span>(m3), <span class="at">y =</span> <span class="fu">residuals</span>(m3))) <span class="sc">+</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">method =</span> <span class="st">"loess"</span>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">+</span> p2) <span class="sc">/</span> (p3 <span class="sc">+</span> p4) <span class="sc">/</span> (p5 <span class="sc">+</span> p6)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Nope. Still some evidence of non-linearity.</p>
<p>What about transforming the explanatory variable <span class="math inline">\(X\)</span> as well?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>p7 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(eg_data, <span class="fu">aes</span>(<span class="at">x =</span> log_x, <span class="at">y =</span> log_y)) <span class="sc">+</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(log_y <span class="sc">~</span> log_x, eg_data)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>p8 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">fitted</span>(m4), <span class="at">y =</span> <span class="fu">residuals</span>(m4))) <span class="sc">+</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">method =</span> <span class="st">"loess"</span>)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>p7 <span class="sc">+</span> p8</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s look at the four model checking plots for the log-log-transformed data:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:14cm"></p>
</figure>
</div>
</div>
</div>
<p>All looks pretty good except for the scale-location plot, which shows a bit of a pattern. But overall, this looks much better than our original model.</p>
<p>But… how to know which transformation to use…? It’s a bit of trial and error. But we can use the model checking plots to help us.</p>
<p><strong>Very very important</strong> is that we do this trial and error before we start using the model. E.g., we don’t want to jump from the aeroplane and then find out that our parachute is not working properly! And then try to fix the parachute while we are falling….</p>
<p>Likewise, we must not start using the model and then try to fix it. We need to make sure our model is in good working order before we start using it.</p>
<p>One of the traps we could fall into is called “p-hacking”. This is when we try different transformation until we find one that gives us the <strong>result we want</strong>, for example significant relationship. This is a big no-no in statistics. We need to decide on the model (including any transformations) before we start using it.</p>
</section>
<section id="common-transformations" class="level3">
<h3 class="anchored" data-anchor-id="common-transformations">Common transformations</h3>
<p>Which transformations could be considered? There is no simple answer. But some guidelines. E.g. if we see non-linearity and increasing variance with increasing fitted values, then a log transform may improve matter.</p>
<p>Some common and useful transformations are:</p>
<ul>
<li>The log transformation for concentrations and absolute values.</li>
<li>The square-root transformation for count data.</li>
<li>The arcsin square-root <span class="math inline">\(\arcsin(\sqrt{\cdot})\)</span> transformation for proportions/percentages.</li>
</ul>
<p>Transformations can also be applied on explanatory variables, as we saw in the example above.</p>
</section>
<section id="outliers" class="level3">
<h3 class="anchored" data-anchor-id="outliers">Outliers</h3>
<p>What do we do when we identify the presence of one or more outliers?</p>
<ol type="1">
<li>Start by checking the “correctness” of the data. Is there a typo or a decimal point that was shifted by mistake? Check both the response and explanatory variables.</li>
<li>If not, ask whether the model could be improved. Do reasonable transformations of the response and/or explanatory variables eliminate the outlier? Do the residuals have a distribution with a long tail (which makes it more likely that extreme observations occur)?</li>
<li>Sometimes, an outlier may be the most interesting observation in a dataset! Was the outlier created by some interesting but different process from the other data points?</li>
<li>Consider that outliers can also occur just by chance!</li>
<li>Only if you decide to report the results of both scenario can you check if inclusion/exclusion changes the qualitative conclusion, and by how much it changes the quantitative conclusion.</li>
</ol>
</section>
<section id="removing-outliers" class="level3">
<h3 class="anchored" data-anchor-id="removing-outliers">Removing outliers</h3>
<p>It might seem tempting to remove observations that apparently don’t fit into the picture. However:</p>
<ul>
<li>Do this <strong>only with greatest care</strong> e.g., if an observation has extremely implausible values!<br>
</li>
<li>Before deleting outliers, check points 1-5 above.</li>
<li>When removing outliers, <strong>you must mention this in your report</strong>.</li>
</ul>
<p>During the course we’ll see many more examples of things going at least a bit wrong. And we’ll do our best to improve the model, so we can be confident in it, and start to use it. Which we will start to do in the next lesson. But before we wrap up, some good news…</p>
</section>
</section>
<section id="its-a-kind-of-magic" class="level2">
<h2 class="anchored" data-anchor-id="its-a-kind-of-magic">Its a kind of magic…</h2>
<p>Above, we learned about linear regression, the equation for it, how to estimate the coefficients, and how to check the assumptions. There was a lot of information, and it might seem a bit overwhelming.</p>
<p>You might also be aware that there are quite a few other types of statistical model, such as multiple regression, t-test, ANOVA, two-way ANOVA, and ANCOVA. It could be worrying to think that you need to learn so much new information for each of these types of tests.</p>
<p>But this is where the kind-of-magic happens. The good news is that the linear regression model is a special case of what is called a <em>general linear model</em>, or just <em>linear model</em> for short. And that all the tests mentioned above are also types of <em>linear model</em>. So, once you have learned about linear regression, you have learned a lot about linear models, and therefore also a lot about all of these other tests as well.</p>
<p>Moreover, the same function in R ‘lm’ is used to make all those statistical models Awesome.</p>
<section id="so-what-is-a-linear-model" class="level3">
<h3 class="anchored" data-anchor-id="so-what-is-a-linear-model">So what is a linear model?</h3>
<p>A linear model is a model where the relationship between the dependent variable and the independent variables is linear. That is, the dependent variable can be expressed as a linear combination of the independent variables. An example of a linear model is:</p>
<p><span class="math display">\[y = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \ldots + \beta_p x_p + \epsilon\]</span></p>
<p>where: <span class="math inline">\(y\)</span> is the dependent variable, <span class="math inline">\(\beta_0\)</span> is the intercept, <span class="math inline">\(\beta_1, \beta_2, \ldots, \beta_p\)</span> are the coefficients of the independent variables, <span class="math inline">\(x_1, x_2, \ldots, x_p\)</span> are the independent variables, <span class="math inline">\(\epsilon\)</span> is the error term.</p>
<p>In contrast, a non-linear model is a model where the relationship between the dependent variable and the independent variables is non-linear. An example of a non-linear model is the exponential growth model:</p>
<p><span class="math display">\[y = \beta_0 + \beta_1 e^{\beta_2 x} + \epsilon\]</span></p>
<p>where: y is the dependent variable, <span class="math inline">\(\beta_0\)</span> is the intercept, <span class="math inline">\(\beta_1, \beta_2\)</span> are the coefficients of the independent variables, <span class="math inline">\(x\)</span> is the independent variable, <span class="math inline">\(\epsilon\)</span> is the error term.</p>
<p>Keep in mind that a model with a quadratic term is still a linear model. For example:</p>
<p><span class="math display">\[y = \beta_0 + \beta_1 x_1 + \beta_2 x^2 + \epsilon\]</span></p>
<p>is still a linear model. We can see this if we substitute <span class="math inline">\(x^2\)</span> with a new variable <span class="math inline">\(x_2\)</span>, where <span class="math inline">\(x_2 = x^2\)</span>. The model then becomes:</p>
<p><span class="math display">\[y = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \epsilon\]</span></p>
<p>This is clearly a linear model.</p>
</section>
</section>
<section id="review" class="level2">
<h2 class="anchored" data-anchor-id="review">Review</h2>
<p>In this chapter we learned about first steps of regression analysis. Specifically, we learned about to:</p>
<ul>
<li>Motivation for regression analysis.</li>
<li>The simple linear regression model.</li>
<li>Estimation of the coefficients (intercept and slope) using the least squares method.</li>
<li>How to model the errors (residuals) and the assumptions of linear regression.</li>
<li>How to check the assumptions of linear regression using model checking plots.</li>
<li>What can go wrong during the modeling process, and how to deal with it.</li>
</ul>
<p>With all that in place, we can be sure that when we use a linear regression model, we can trust the results it gives us. In the next chapter, we will start to use linear regression models to answer questions! This involves things such as hypothesis testing, confidence intervals, and prediction. Exciting times ahead!</p>
</section>
<section id="further-reading" class="level2">
<h2 class="anchored" data-anchor-id="further-reading">Further reading</h2>
<p>There are many good books and online resources about regression models, fitting them, and checking their assumptions. Here are some suggestions for further reading:</p>
<ul>
<li>For a more mathematical treatment, including matrix representation, see Chapter 2 of Faraway, J. J. (2016). Linear models with R (2nd ed.). Chapman and Hall/CRC. <a href="https://www.routledge.com/Linear-Models-with-R-2nd-Edition/Faraway/p/book/9781482215754">Link</a></li>
<li>The same book (Faraway) covers Diagnostics and model checking in Chapter 5.</li>
<li>For a complementary perspective on regression, see Chapter 7 of The New Statistics with R, by Andy Hector.</li>
</ul>
</section>
<section id="extras" class="level2">
<h2 class="anchored" data-anchor-id="extras">Extras</h2>
<section id="tests-for-normality" class="level3">
<h3 class="anchored" data-anchor-id="tests-for-normality">Tests for normality</h3>
<p>We often want to know if our data or our residuals are not normally distributed. You’ve now done a lot with QQ-plots to examine how normally distributed your data are. Some people also like to have a statistical test for normality. Here I’ll show some tests.</p>
<section id="shapirowilk-test-on-normally-distributed-data" class="level4">
<h4 class="anchored" data-anchor-id="shapirowilk-test-on-normally-distributed-data">Shapiro–Wilk test on normally distributed data</h4>
<p>The Shapiro–Wilk test is frequently used.</p>
<ul>
<li><strong>Null hypothesis:</strong> the data are normally distributed<br>
</li>
<li><strong>Alternative hypothesis:</strong> the data are not normally distributed</li>
</ul>
<p>Let’s make some data and look at its distribution and QQ-plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">145</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">100</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">x=</span>x), <span class="fu">aes</span>(<span class="at">x=</span>x)) <span class="sc">+</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>Yes, this is the distribution of data that come from a normal distribution.</p>
<p>And the QQ-plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(x)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>Looks pretty normal. Let’s see what the Shapiro–Wilk test tells us:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">shapiro.test</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  x
W = 0.99467, p-value = 0.9658</code></pre>
</div>
</div>
<p>The p-value for the test is large (e.g.&nbsp;p ≈ 0.99). When we get a large p-value like this, it means we <strong>cannot reject the null hypothesis</strong>. (A small p-value, say p &lt; 0.05, would cause us to reject the null hypothesis.) Hence, here, we cannot reject the null hypothesis that the data are normally distributed. (Note that, as usual, technically we cannot <em>accept</em> the null hypothesis.)</p>
<p>So we can happily continue with any work that assumes normally distributed residuals.</p>
</section>
<section id="shapirowilk-test-on-non-normally-distributed-data" class="level4">
<h4 class="anchored" data-anchor-id="shapirowilk-test-on-non-normally-distributed-data">Shapiro–Wilk test on non-normally distributed data</h4>
<p>Now let’s repeat this exercise using data that we <em>know</em> are not normally distributed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">100</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">x=</span>x), <span class="fu">aes</span>(<span class="at">x=</span>x)) <span class="sc">+</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>This is clearly not normally distributed data.</p>
<p>And the QQ-plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(x)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-56-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>OK, we don’t need to do a test to see that this is not normally distributed data. But let’s do it anyway:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">shapiro.test</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  x
W = 0.92167, p-value = 1.728e-05</code></pre>
</div>
</div>
<p>Now the p-value is small, so we <strong>reject the null hypothesis</strong> that the data are normally distributed. Now we can’t continue with methods, such as linear models, that assume normally distributed residuals.</p>
</section>
<section id="what-if-we-have-fewer-data-points" class="level4">
<h4 class="anchored" data-anchor-id="what-if-we-have-fewer-data-points">What if we have fewer data points?</h4>
<p>What about if we have fewer data points, say 30? And let’s do the test lots of times and count how often we reject the null hypothesis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">1000</span>, <span class="fu">shapiro.test</span>(<span class="fu">runif</span>(<span class="dv">30</span>))<span class="sc">$</span>p.value)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(x <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 371</code></pre>
</div>
</div>
<p>So we reject the null hypothesis in about <strong>38% of the trials</strong>. That is, we <em>don’t</em> reject the hypothesis that the data are normally distributed in nearly <strong>40% of cases</strong>, even though the data came from a uniform distribution!</p>
</section>
<section id="shapirowilk-test-on-real-data" class="level4">
<h4 class="anchored" data-anchor-id="shapirowilk-test-on-real-data">Shapiro–Wilk test on real data</h4>
<p>How useful this (or any) test of normality is depends on our data.</p>
<ul>
<li>If we have a <strong>large sample</strong>, the test has very <strong>high power</strong>, and we can easily reject the null hypothesis due to tiny deviations from normality.</li>
<li>If we have a <strong>small sample</strong>, we could easily fail to reject the null hypothesis even when the generating process does not create normally distributed data. The test has <strong>low power</strong> for small samples.</li>
</ul>
<p>Here’s an example of the latter point. We make data that has 5000 numbers sampled from a normal distribution, and then add a bit of non-normality:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">5000</span>) <span class="co">#+ c(1, 0, 2, 0, 1)</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">x=</span>x), <span class="fu">aes</span>(<span class="at">x=</span>x)) <span class="sc">+</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>Looks pretty normal.</p>
<p>And the QQ-plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(x)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>And the test.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">shapiro.test</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  x
W = 0.99966, p-value = 0.5779</code></pre>
</div>
</div>
<p>Uh oh! The test rejects the null hypothesis.</p>
</section>
<section id="so-what-do-we-do" class="level4">
<h4 class="anchored" data-anchor-id="so-what-do-we-do">So what do we do?</h4>
<p>Actually, we might be focusing on the wrong question. Instead of asking <em>how close to normally distributed</em> our data are, we should consider:</p>
<ul>
<li>how <strong>robust</strong> our analysis is to deviations from normality, and<br>
</li>
<li>which types of deviations from normality actually matter.</li>
</ul>
<p>Generally speaking, <strong>linear models are robust</strong> to deviations from normality.</p>
<p>This means:</p>
<ul>
<li>we can be relatively happy that the Shapiro–Wilk test lacks power with small samples, and<br>
</li>
<li>we should be cautious about rejecting normality when sample sizes are large.</li>
</ul>
</section>
</section>
<section id="more-insight-from-qq-plots" class="level3">
<h3 class="anchored" data-anchor-id="more-insight-from-qq-plots">More insight from QQ-plots</h3>
<p>It is quite subjective to decide if a QQ-plot looks ok, or not. And if the tests are not so useful, what can we do?</p>
<p>One option is to make use of simulation to see what kind of variation we can expect in QQ-plots, even when the data really do come from a normal distribution.</p>
<p>Here is an example of such a plot (the code to make it is below):</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="3.1-regression-part1_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The red dots are is the qqplot of the observed data. The grey lines are qqplots of normally distributed random data, with characteristics equal to those assumed by the model. Each grey line is a separate draw of random numbers. So the grey lines give an idea of what kind of spread one can expect even when the data really do come from a normal distribution. If the red points lie within the grey region, we’re good to go!</p>
<p>Some of the upper red dots are at the edge of grey region, suggesting there might be minor deviations from normality. Hence, even with some help given by showing what we can expect to see, we still have to make an arbitrary / rather subjective decision about when deviations are bad enough to warrant doing something, and when they are not so bad, and we can continue with the assumption of normality. Much of data analysis is more subjective that we might expect given that it is quantitative!</p>
<p>Here is the code to make the graph, using some example data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="do">## function adapted from</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="do">## http://www.nate-miller.org/1/post/2013/03/how-normal-is-normal-a-q-q-plot-approach.html</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>qqfunc <span class="ot">&lt;-</span> <span class="cf">function</span>(model, num.reps) {</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">resid</span>(model))</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  sigma <span class="ot">&lt;-</span> <span class="fu">summary</span>(model)<span class="sc">$</span>sigma</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="dv">0</span>, sigma)</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  xx <span class="ot">&lt;-</span> <span class="fu">qqnorm</span>(x, <span class="at">plot.it=</span>F)</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  xx<span class="sc">$</span>y <span class="ot">&lt;-</span> xx<span class="sc">$</span>y[<span class="fu">order</span>(xx<span class="sc">$</span>x)]</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  xx<span class="sc">$</span>x <span class="ot">&lt;-</span> xx<span class="sc">$</span>x[<span class="fu">order</span>(xx<span class="sc">$</span>x)]</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(xx<span class="sc">$</span>x, <span class="fu">scale</span>(xx<span class="sc">$</span>y), <span class="at">pch=</span><span class="dv">19</span>, <span class="at">col=</span><span class="st">"#00000011"</span>, <span class="at">type=</span><span class="st">"l"</span>,</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab=</span><span class="st">"Theoretical quantiles"</span>,</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">ylab=</span><span class="st">"Standardised residuals"</span>)</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>  <span class="do">##qqline(x)</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>num.reps) {</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="dv">0</span>, sigma)</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>    xx <span class="ot">&lt;-</span> <span class="fu">qqnorm</span>(x, <span class="at">plot.it=</span>F)</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>    xx<span class="sc">$</span>y <span class="ot">&lt;-</span> xx<span class="sc">$</span>y[<span class="fu">order</span>(xx<span class="sc">$</span>x)]</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>    xx<span class="sc">$</span>x <span class="ot">&lt;-</span> xx<span class="sc">$</span>x[<span class="fu">order</span>(xx<span class="sc">$</span>x)]</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(xx<span class="sc">$</span>x, <span class="fu">scale</span>(xx<span class="sc">$</span>y), <span class="at">pch=</span><span class="dv">19</span>, <span class="at">col=</span><span class="st">"#00000011"</span>, <span class="at">type=</span><span class="st">"l"</span>)</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>  xx <span class="ot">&lt;-</span> <span class="fu">qqnorm</span>(m1<span class="sc">$</span>residuals, <span class="at">plot.it=</span>F)</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(xx<span class="sc">$</span>x, <span class="fu">scale</span>(xx<span class="sc">$</span>y), <span class="at">col=</span><span class="st">"red"</span>, <span class="at">pch=</span><span class="dv">19</span>)</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a><span class="do">## load some useful packages</span></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggfortify)</span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a><span class="do">## load the data</span></span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a><span class="do">## Here I'm loading it direct from online where the dataset are stored</span></span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>fhc <span class="ot">&lt;-</span> <span class="fu">suppressMessages</span>(readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"https://raw.githubusercontent.com/opetchey/BIO144_Practicals_WAs/refs/heads/main/assets/datasets/financing_healthcare.csv"</span>,<span class="at">show_col_types =</span> <span class="cn">FALSE</span>))</span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a><span class="do">## tell me which countries are in the dataset</span></span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a><span class="co">#unique(fhc$country)</span></span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a><span class="do">## tell me which years are in the dataset</span></span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a><span class="co">#unique(fhc$year)</span></span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a><span class="do">## give me the rows in which both child mortality and health care expenditure are not NA</span></span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a><span class="co">#filter(fhc, !is.na(child_mort) &amp; !is.na(health_exp_total))</span></span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a><span class="do">## Wrange the data</span></span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>fhc1 <span class="ot">&lt;-</span> fhc <span class="sc">%&gt;%</span></span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year<span class="sc">==</span><span class="dv">2013</span>) <span class="sc">%&gt;%</span> <span class="do">## only data fro 2013 please</span></span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(year<span class="sc">:</span>continent, health_exp_total, child_mort, life_expectancy) <span class="sc">%&gt;%</span> <span class="do">## only these columns please</span></span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="do">## drop rows with any NAs</span></span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a><span class="do">## From last weeks work we know we need to log transform the data</span></span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a>fhc1 <span class="ot">&lt;-</span> <span class="fu">mutate</span>(fhc1,</span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a>               <span class="at">log10_health_exp_total=</span><span class="fu">log10</span>(health_exp_total),</span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a>               <span class="at">log10_child_mort=</span><span class="fu">log10</span>(child_mort))</span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a><span class="do">## plot the relationship between health care expenditure and child mortality</span></span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a><span class="co">#ggplot(data=fhc1, aes(x=health_exp_total, y=child_mort)) + geom_point()</span></span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a><span class="do">## fit the linear model of the log transformed data and assign it to object named m1</span></span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(log10_child_mort <span class="sc">~</span> log10_health_exp_total, <span class="at">data=</span>fhc1)</span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a><span class="do">## Here we run the function that makes the qqplot with some random samples from a normal distribution</span></span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a><span class="fu">qqfunc</span>(m1, <span class="dv">100</span>)</span>
<span id="cb53-69"><a href="#cb53-69" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/opetchey\.github\.io\/BIO144_Course_Book\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./2.1-R-and-RStudio.html" class="pagination-link" aria-label="R and RStudio (L2)">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">R and RStudio (L2)</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./4.1-regression-part2.html" class="pagination-link" aria-label="Regression Part 2 (L4)">
        <span class="nav-page-text">Regression Part 2 (L4)</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>BIO144 Data Analysis for Biologists, Course Book written by Owen Petchey</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/opetchey/BIO144_Course_Book/edit/main/3.1-regression-part1.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/opetchey/BIO144_Course_Book/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>This book was built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>




</body></html>