{"title":"Regression (L3&4)","markdown":{"headingText":"Regression (L3&4)","headingAttr":{"id":"","classes":["unnumbered"],"keyvalue":[]},"containsRefs":false,"markdown":"```{r}\nsuppressMessages(library(tidyverse))\n```\n\n\n\nThis chapter contains the content of the third and fourth Monday lecture of the course BIO144 Data Analysis in Biology at the University of Zurich. When\n\n## Introduction\n\nLinear regression is a common statistical method that models the relationship between a dependent (response) variable and one or more independent (explanatory) variables. The relationship is modeled with the equation for a straight line ($y = a + bx$).\n\nWith linear regression we can answer questions such as:\n\n* How does the dependent (response) variable change with respect to the independent (explanatory) variable?\n* What amount of variation in the dependent variable can be explained by the independent variable?\n* Is there a statistically significant relationship between the dependent variable and the independent variable?\n* Does the linear model fit the data well?\n\nIn this chapter / lesson we will explore what is linear regression and how to use it to answer these questions. We'll cover the following topics:\n\n* Why use linear regression?\n* What is the linear regression model?\n* Fitting the regression model (= finding the intercept and the slope).\n* Is linear regression a good enough model to use?\n* What do we do when things go wrong?\n* Transformation of variables/the response.\n* Identifying and handling odd data points (aka outliers).\n\nIn this chapter / lesson we will not discuss the statistical significance of the model. We will cover this topic in the next chapter / lesson.\n\n\n### Why use linear regression?\n\n* It's a good starting point because it is a relatively simple model.\n* Relationships are sometimes close enough to linear.\n* It's easy to interpret.\n* It's easy to use.\n* It's actually quite flexible (e.g. can be used for non-linear relationships, e.g., a quadratic model is still a linear model!!! See @sec-kind-of-magic.).\n\n### An example - blood pressure and age\n\nThere are lots of situations in which linear regression can be useful. For example, consider hypertension. Hypertension is a condition in which the blood pressure in the arteries is persistently elevated. Hypertension is a major risk factor for heart disease, stroke, and kidney disease. It is estimated that hypertension affects about 1 billion people worldwide. Hypertension is a complex condition that is influenced by many factors, including age. In fact, it is well known that blood pressure increases with age. But how much does blood pressure increase with age? This is a question that can be answered using linear regression.\n\nHere is an example of a study that used linear regression to answer this question:\nhttps://journals.lww.com/jhypertension/fulltext/2021/06000/association_of_age_and_blood_pressure_among_3_3.15.aspx\n\nIn this study, the authors used linear regression to model the relationship between age and blood pressure. They found that systolic blood pressure increased by 0.28--0.85 mmHg/year. This is a small increase, but it is statistically significant. This means that the observed relationship between age and blood pressure is unlikely to be due to chance.\n\nLets look at some simulated example data:\n\n```{r}\n# Load the data\nbp_age_data <- read.csv(\"data/Simulated_Blood_Pressure_and_Age_Data.csv\")\n\n# How many data points with both age and blood pressure?\nbp_age_data <- na.omit(bp_age_data)\n# No rows with missing values\n\n# Visualize the data\nggplot(bp_age_data, aes(x = Age, y = Systolic_BP)) +\n  geom_point() +\n  labs(title = \"Systolic Blood Pressure vs. Age\",\n       x = \"Age\",\n       y = \"Systolic Blood Pressure\")\n\n```\n\nWell, that is pretty conclusive. We hardly need statistics. There is a clear positive relationship between age and systolic blood pressure. But how can we quantify this relationship? And in less clear-cut cases what is the strength of evidence for a relationship? This is where linear regression comes in. Linear regression models the relationship between age and systolic blood pressure. With linear regression we can answer the following questions:\n\n* What is a good mathematical representation of the relationship?\n* Is the relationship different from what we would expect if there were no relationship?\n* How well does the mathematical representation match the observed values?\n* How much uncertainty is there in any predictions?\n\nLets try to figure some of these out from the visualisation.\n\n::: {.callout-tip}\n## Think, Pair, Share\n\n* Make a guess of the slope.\n* Make a guess of the intercept (hint be careful, lots of people get this wrong).\n:::\n\n\n### Regression from a mathematical perspective\n\nGiven an **independent/explanatory variable** ($X$) and a **dependent/response variable** ($Y$) all points $(x_i,y_i)$, $i= 1,\\ldots, n$, on a  straight line follow the equation\n\n$$y_i = \\beta_0 + \\beta_1 x_i\\ .$$\n\n* $\\beta_0$ is the **intercept** - the value of $Y$ when $x_i = 0$\n* $\\beta_1$ the **slope** of the line, also known as the regression coefficient of $X$.\n* If $\\beta_0=0$ the line goes through the origin $(x,y)=(0,0)$.\n* **Interpretation** of linear dependency: proportional increase in $y$ with increase (decrease) in $x$.\n\n\n\n\n\n\n\n### But a straight line cannot perfectly fit the data\n\n```{r}\n# Visualize the data\nggplot(bp_age_data, aes(x = Age, y = Systolic_BP)) +\n  geom_point() +\n  labs(title = \"Systolic Blood Pressure vs. Age\",\n       x = \"Age\",\n       y = \"Systolic Blood Pressure\") +\n  geom_smooth(formula = y ~ x, method = \"lm\", se = FALSE)\n\n```\n\nThe line is not a perfect fit to the data. There is scatter around the line. \n\nSome of this scatter could be caused by other factors that influence blood pressure, such as diet, exercise, and genetics. Also, the there could be differences due to the measurement instrument (i.e., some measurement error).\n\nThese other factors are not included in the model (only age is in the model), so they create variation that can only appear in error term.\n\nIn the linear regression model the dependent variable $Y$ is related to the independent variable $x$ as\n\n$$Y = \\beta_0 + \\beta_1 x + \\epsilon \\ $$\nwhere\n\n* $\\epsilon$ is the error term\n* $\\beta_0$ is the intercept\n* $\\beta_1$ is the slope\n* $\\epsilon$ is the error term.\n\nThe error term captures the difference between the observed value of the dependent variable and the value predicted by the model. The error term includes the effects of other factors that influence the dependent variable, as well as measurement error.\n\n\n$$Y \\quad= \\quad \\underbrace{\\text{expected value}}_{E(Y) = \\beta_0 + \\beta_1 x} \\quad + \\quad \\underbrace{\\text{random error}}_{\\epsilon}  \\ .$$\n\n\nGraphically the error term is the vertical distance between the observed value of the dependent variable and the value predicted by the model.\n\n\n```{r}\n# filter for only one data point per age\nfiltered_data <- bp_age_data[!duplicated(bp_age_data$Age),]\n# First make the linear model and getting the predicted values\nmodel <- lm(Systolic_BP ~ Age, data = filtered_data)\npredicted_values <- predict(model)\n# Then show the residuals with vertical lines\nggplot(filtered_data, aes(x = Age, y = Systolic_BP)) +\n  geom_point() +\n  geom_smooth(formula = y ~ x, method = \"lm\", se = FALSE, color = \"blue\") +\n  geom_segment(aes(xend = Age, yend = predicted_values), color = \"red\") +\n  labs(title = \"Systolic Blood Pressure vs. Age\\nFiltered for only one data point per age year\",\n       x = \"Age\",\n       y = \"Systolic Blood Pressure\") \n```\n\nThe error term is also known as the residual. It is the variation that *resides* (is left over / is left unexplained) after accounting for the relationship between the dependent and independent variables.\n\n### Dealing with the error\n\nIf we use each of the observed residuals as the error for the respective data point, we end up with a perfect fit to the data. This is because the model is fitted to the data, so the residuals are the difference between the observed value of the dependent variable and the value predicted by the model. We then have a model with no error -- everything is explained by the model. This is known as over-fitting. In fact, we have gained nothing by fitting the model, because we have not learned anything about the relationship between the dependent and independent variables. We have simply memorized / copied the data!!!\n\nIn order to avoid this, we need to assume something about the residuals -- we need to *model* the error term. The most common model for the error term is normally distributed with mean 0 and constant variance.\n\n$$\\epsilon \\sim N(0,\\sigma^2)$$\n\n**This is known as the normality assumption.** The normality assumption is important because it allows us to make inferences about the population parameters based on the sample data.\n\nThe linear regression model then becomes:\n\n$$Y = \\beta_0 + \\beta_1 x + N(0,\\sigma^2) \\ $$\n\nwhere $\\sigma^2$ is the variance of the error term. The variance of the error term is the amount of variation in the dependent variable that is not explained by the independent variable. The variance of the error term is also known as the residual variance.\n\nAn alternate and equivalent formulation is that $Y$ is a random variable that follows a normal distribution with mean $\\beta_0 + \\beta_1 x$ and variance $\\sigma^2$.\n\n$$Y \\sim N(\\beta_0 + \\beta_1 x, \\sigma^2)$$\n\nSo, the answer to the question \"how do we deal with the error term\" is that we model the error term as normally distributed with mean 0 and constant variance. Put another way, the error term is assumed to be normally distributed with mean 0 and constant variance. \n\n\n\n### Back to blood pressure and age\n\nThe mathematical model in this case is:\n\n$$SystolicBP = \\beta_0 + \\beta_1 \\times Age + \\epsilon$$\n\nwhere:\n*SystolicBP* is the dependent (response) variable,\n$\\beta_0$ is the intercept,\n$\\beta_1$ is the coefficient of Age,\n*Age* is the independent (explanatory) variable,\n$\\epsilon$ is the error term.\n\nLet's ensure we understand this, by thinking about the units of the variables in this model. This can be very useful because it can help us to understand the model better and to check that the model makes sense.\n\n\n::: {.callout-tip}\n## Think, pair, share\n\n* What are the units of blood pressure?\n* What are the units of age?\n* What are the units of the intercept?\n* What are the units of the coefficient of Age?\n* What are the units of the error term?\n:::\n\n\nWe can easily guess that the coefficient of Age is positive, because blood pressure tends to increase with age. But what is the most likely value of this coefficient? We need to estimate the coefficient of Age from the data. This is what linear regression does. It estimates the coefficients (intercept and slope) of the independent variables in the model.\n\n## Finding the intercept and the slope\n\nIn a regression analysis, one task is to estimate the intercept and the slope. These are known as the **regression coefficients** $\\beta_0$, $\\beta_1$. (We also estimate the **residual variance** $\\sigma^2$.)\n\n* **Problem**: For more than two points $(x_i,y_i)$, $i=1,\\ldots, n$, there is generally no perfectly fitting line.\n\n* **Aim:** We want to estimate the parameters $(\\beta_0,\\beta_1)$ of the **best fitting** line $Y = \\beta_0 + \\beta_1 x$.\n\n* **Idea:** Find the **best fitting line** by minimizing the deviations between the data points $(x_i,y_i)$ and the regression line. I.e., minimising the residuals.\n\nBut which deviations?\n\nThese ones?\n\n```{r}\nset.seed(9670)\nn <- 10\nx <- rnorm(n)\ny <- 4 - 2*x + rnorm(n,0,sd=1)\nx[11]  <- -0.5\ny[11] <- 6.2\nplot(x,y)\nx1 <- -0.66\nabline(c(4,-2),lwd=2)\nsegments(x[11],y[11],x1,4-2*(x1),col=2,lwd=2)\n```\n\nOr these?\n\n```{r}\nset.seed(9670)\nn <- 10\nx <- rnorm(n)\ny <- 4 - 2*x + rnorm(n,0,sd=1)\nx[11]  <- -0.5\ny[11] <- 6.2\nplot(x,y)\nabline(c(4,-2),lwd=2)\nsegments(x[11],y[11],x[11],4-2*x[11],col=2,lwd=2)\n```\n\nOr maybe even these?\n\n```{r}\nset.seed(9670)\nn <- 10\nx <- rnorm(n)\ny <- 4 - 2*x + rnorm(n,0,sd=1)\nx[11]  <- -0.5\ny[11] <- 6.2\nplot(x,y)\nabline(c(4,-2),lwd=2)\nsegments(x[11],y[11],(y[11]-4)/(-2),y[11],col=2,lwd=2)\n```\n\nWell, actually its none of these!!!\n\n### Least squares\n\nFor multiple reasons (theoretical aspects and mathematical convenience), the intercept and slope are estimated using the **least squares** approach. In this, yet something else is minimized:\n\nThe parameters $\\beta_0$ and $\\beta_1$ are estimated such that the **sum of squared vertical distances** (sum of squared residuals / errors) is minimised.\n\n**SSE** means **S**um of **S**quared **E**rrors:\n\n$$SSE = \\sum_{i=1}^n e_i^2 $$\n\nwhere,\n\n$$e_i = y_i - \\underbrace{(\\beta_0 + \\beta_1 x_i)}_{=\\hat{y}_i} $$\n**Note:** $\\hat y_i = \\beta_0 + \\beta_1 x_i$ are the *predicted values*.\n\nIn the graph just below, one of these squares is shown in red. \n\n\n```{r}\nset.seed(9670)\nn <- 10\nx <- rnorm(n)\ny <- 4 - 2*x + rnorm(n,0,sd=1)\nx[11]  <- -0.5\ny[11] <- 6.2\ndd <- 0.38\nfrom_x <- c(x[11],x[11],x[11]+dd,x[11] + dd) \nfrom_y <- c(y[11],(4-2*x[11]),(4-2*x[11]),y[11])\n\nto_x <- c(x[11],x[11] + dd,x[11]+ dd,x[11])\nto_y <- c(4-2*x[11],4-2*x[11],y[11], y[11])\n\nplot(x,y)\nabline(c(4,-2),lwd=2)\npolygon(from_x,from_y,to_x,to_y,col=2,lwd=2)\n```\n\n### Least squares estimates\n\nWith a linear model, we can calculate the least squares estimates of the parameters $\\beta_0$ and $\\beta_1$ directly using the following formulas.\n\nFor a given sample of data $(x_i,y_i), i=1,..,n$, with mean values $\\overline{x}$ and $\\overline{y}$, the least squares estimates $\\hat\\beta_0$ and $\\hat\\beta_1$ are computed as \n\n\n$$ \\hat\\beta_1 = \\frac{\\sum_{i=1}^n  (y_i - \\overline{y}) (x_i - \\overline{x})}{ \\sum_{i=1}^n (x_i - \\overline{x})^2 } = \\frac{cov(x,y)}{var(x)}$$\n\n$$\\hat\\beta_0 = \\overline{y} - \\hat\\beta_1 \\overline{x}  $$\n\nMoreover,\n\n\n$$ \\hat\\sigma^2 = \\frac{1}{n-2}\\sum_{i=1}^n e_i^2 \\quad \\text{with residuals  } e_i = y_i - (\\hat\\beta_0 + \\hat\\beta_1 x_i) $$\n\nis an unbiased estimate of the residual variance $\\sigma^2$.\n\n(Derivations of the equations above are in the Stahel script 2.A b. Hint: differentiate, set to zero, solve.)\n\n### Why division by $n-2$ ensures an unbiased estimator\n\nWhen estimating parameters ($\\beta_0$ and $\\beta_1$), the square of the residuals is minimised. This fitting process inherently *uses up* two *degrees of freedom*, as the model forces the residuals to sum to zero and aligns the slope to best fit the data. I.e., one degree of freedom is lost due to the estimation of the intercept, and another due to the estimation of the slope.\n\nThe adjustment (division by $n-2$ instead of $n$) compensates for the loss of variability due to parameter estimation, ensuring the estimator of the residual variance is unbiased. Mathematically, dividing by n - 2 adjusts for this loss and gives an accurate estimate of the population variance when working with sample data.\n\nWe'll look at degrees of freedom in more detail later, so don't worry if this is a bit confusing right now.\n\n### Let's do it in R\n\nFirst we read in the dataset:\n\n```{r}\n#| echo: true\nbp_age_data <- read.csv(\"data/Simulated_Blood_Pressure_and_Age_Data.csv\")\n```\n\nThe we make a graph of the data:\n\n```{r}\nggplot(bp_age_data, aes(x = Age, y = Systolic_BP)) +\n  geom_point() +\n  labs(x = \"Age (years)\", y = \"Systolic Blood Pressure (mmHg)\")\n```\n\n\n\nThen we make the linear model, using the `lm()` function:\n\n```{r}\nbp_age_model <- lm(Systolic_BP ~ Age, data = bp_age_data)\n```\n\nThen we can look at the summary of the model. It contains a lot of information, so can be a bit confusing at first. \n\n```{r}\nsummary(bp_age_model)\n```\n\nHow do our guesses of the intercept and slope compare to the guesses we made earlier?\n\nRecal that the units of the *Age* coefficient are in mmHg per year. This means that for each additional year of age, the systolic blood pressure increases by ´r round(coef(bp_age_model)[2],2)´ mmHg.\n\n## Is the model good enough to use?\n\n* All models are wrong, but is ours good enough to be useful?\n* Are the assumption of the model justified?\n* It would be very unwise to use the model before we know if it is good enough to use.\n* Don't jump out of an aeroplane until you know your parachute is good enough!\n\n\n\n### What assumptions do we make?\n\nWe already heard about one. We assume that the residuals follow a $N(0,\\sigma^2)$ distribution. We make this assumption because it is often well enough met, and it gives great mathematical tractability.\n\nThis assumption implies that:\n\n(a) The $\\epsilon_i$ are normally distributed.\n(b) All $\\epsilon_i$ have the same variance: $Var(\\epsilon_i)=\\sigma^2$.\n(c) The $\\epsilon_i$ are independent of each other.\n\nFurthermore:\n\n(d) we assumed a linear relationship.\n(e) implies there are no outliers (implied by (a) above)\n\n\nLets go through each five assumptions.\n\n### (a) Normally distributed residuals\n\nWhat does this mean? How can we check it?\n\nA normal distribution is symmetric and bell-shaped...\n\n```{r}\nggplot(data.frame(x = c(-4, 4)), aes(x)) + \n  stat_function(fun = dnorm, n = 101) + \n  theme_minimal()\n```\n\nLets look at the frequency distribution of the residuals of the linear regression of blood pressure and age:\n\n\n```{r}\nggplot(data = bp_age_data, aes(x = residuals(bp_age_model))) +\n  geom_histogram(bins = 10) +\n  theme_minimal()\n```\n\nThe normal distribution assumption (a) seems ok as well.\n\n\n### (a) Normally distributed residuals: The QQ-plot\n\nUsually, not the histogram of the residuals is plotted, but the\nso-called **quantile-quantile** (QQ) plot. The quantiles of the\nobserved distribution are plotted against the quantiles of the\nrespective theoretical (normal) distribution:\n\n```{r}\nqqnorm(residuals(bp_age_model))\nqqline(residuals(bp_age_model))\n```\n\nIf the points lie approximately on a straight line, the data is fairly\nnormally distributed.\n\nThis is often \"tested\" by eye, and needs some experience.\n\n*But what on earth is a quantile???*\n\nImagine we make 21 measures of something, say 21 blood pressures:\n\n```{r fig.width=8, fig.height=2}\nset.seed(1)\ndd <- dplyr::tibble(Blood_Pressure = round(rnorm(21, 120, 20),1))\nggplot(dd) +\n  geom_jitter(aes(y=1, x=Blood_Pressure)) +\n  theme(axis.title.y=element_blank(),\n        axis.text.y=element_blank(),\n        axis.ticks.y=element_blank())\n```\n\nThe median of these is `r median(dd$Blood_Pressure)`. The median is the\n50% or 0.5 quantile, because half the data points are above it, and half\nbelow.\n\n```{r}\nquantile(dd$Blood_Pressure, 0.5)\n```\n\n\nThe *theoretical quantiles* come from the normal distribution. The\n*sample quantiles* come from the distribution of our residuals.\n\n```{r fig.width=8, fig.height=4}\npar(mfrow=c(1,2))\nx<-seq(-3,3,0.1)\nstdr <- sort(scale(bp_age_model$residuals))\n\ns <- seq(2)  # one shorter than data\nx <- c(-2.5,qnorm(0.6),qnorm(0.6))\ny <- c(0.6,0.6,0)\n\nplot(stdr,pnorm(stdr),xlab=\"Theoretical quantiles\",ylab=\"Theoretical cumulative distribution\")\narrows(x[s], y[s], x[s+1], y[s+1])\nn<-nrow(bp_age_data)\nplot(stdr,(1:n)/n,xlab=\"Sample quantiles of the residuals\",ylab=\"Empirical cumulative distribution\")\narrows(x[s], y[s], x[s+1], y[s+1])\n```\n\n\n#### How do I know if a QQ-plot looks \"good\"?\n\nThere is **no quantitative rule** to answer this question. Instead experience is needed. You can gain this experience from simulations. To this end, we can generate the same number of data points of a normally distributed variable and compare this simulated qqplot to our observed one.\n\nExample: Generate 100 points $\\epsilon_i \\sim N(0,1)$ each time:\n\n```{r}\nset.seed(390457)\npar(mfrow=c(2,3),mar=c(4,4,1,1))\nfor (ii in 1:6){\n  ss <- rnorm(100)\nqqnorm(ss,main=\"\")\nqqline(ss,xlab=\"\")\n}\n```\n\nEach of the graphs above has data points that are randomly generated from a normal distribution. In all cases the data points are close to the line. This is what we would expect if the data were normally distributed. The amount of deviation from the line is what we would expect from random variation, and so seeing this amount of variation in a QQ-plot of your model should not be cause for concern.\n\n\n### (b) Equal variance (homoscedasticity)\n\nBasically, we're interested if the size of the residuals tends to show a pattern with the fitted values. By *size* of the residuals we mean the *absolute value* of the residuals.\n\nWe have assumed that there is no relationship between the residuals and the fitted values.\n\nThat is, variance of the residuals is a constant: $\\text{Var}(\\epsilon_i) = \\sigma^2$. And not, for example $\\text{Var}(\\epsilon_i) = \\sigma^2 \\cdot x_i$.\n\nSo we're going to plot the size of the residuals against the fitted values.\n\nThis graph is known as the scale-location plot. It is particularly suited to check the assumption of equal variances (__homoscedasticity / Homoskedastizität__).\n\nThe idea is to plot the square root of the (standardized) residuals $\\sqrt{|R_i|}$ against the fitted values $\\hat{y_i}$. There should be __no trend__: \n\n```{r}\nplot(bp_age_model, which=3, add.smooth = FALSE)\n```\n\n#### How it looks with the variance increasing with the fitted values\n\nHere's a graphical example of how it would look if the variance of the residuals increases with the fitted values.\n\nFirst here is a graph of the relationship:\n\n```{r}\nset.seed(2)\nx <- runif(100, 1, 10)\ny <- 100 + 5*x + 2*x*rnorm(100,0,1)\nggplot(data.frame(x=x,y=y), aes(x=x,y=y)) +\n  geom_point() +\n  geom_smooth(formula = y ~ x, method=\"lm\", se=FALSE)\n```\n\nAnd here the scale-location plot for a linear model of that data:\n\n```{r}\nm <- lm(y~x)\nplot(m,which=3)\n```\n\n\n\n### (c) Independence (the $\\epsilon_i$ are independent of each other)\n\nWe assume that the residuals are independent of each other. This means that the value of one residual is not somehow related to the value of another.\n\nThe dataset about blood pressure we looked at contained 100 observations, each one made from a different person. In such a study design, we could be safe in the assumption that the people are independent, and therefore the assumption that the residuals are independent.\n\nImagine, however, if we had 100 observations of blood pressure collected from 50 people, because we measured the blood pressure of each person twice. In this case, the residuals would not be independent, because two measures of the blood pressure of the same person are likely to be similar. A person is likely to have a high blood pressure in both measurements, or a low blood pressure in both measurements. This would mean they have a high residual in both measurements, or a low residual in both measurements.\n\nIn this case, we would need to account for the fact that the residuals are not independent. We would need to use a more complex model, such as a mixed effects model, to account for the fact that the residuals are not independent. We will talk about this again in the last week of this course.\n\nIn general, you should always think about the study design when you are analysing data. You should always think about whether the residuals are likely to be independent of each other. If they are not, you should think about how you can account for this in your analysis.\n\nA good way to assess if there could be dependencies in the residuals is to be critical about what is the unit of observation in the data. In the blood pressure example, the unit of observation is the person. Count the number of persons in the study. If there are fewer persons than observations, then at least some people must have been measured at least twice. Repeating measures on the same person is a common way to get dependent residuals.\n\nSo, to check the assumption of independence, you should:\n  \n* Think carefully about the study design.\n* Think carefully about the unit of observation in the data.\n* Compare the number of observations to the number of units of observation.\n\n\n\n### (d) Linearity assumption\n\nThe linearity assumption states that the relationship between the independent variable and the dependent variable is linear. This means that the dependent variable changes by a constant amount for a one-unit change in the independent variable. And that this slope is does not change with the value of the independent variable.\n\nThe blood pressure data seems to be linear:\n  \n```{r}\nggplot(bp_age_model, aes(x = Age, y=Systolic_BP)) +\n  geom_point() +\n  geom_smooth(formula = y ~ x, method=\"lm\", se=FALSE)\n```\n\nIn contrast, look at this linear regression through data that appears non-linear:\n\n```{r}\nset.seed(1)\nx <- runif(100, 1, 10)\ny <- 2*x + rnorm(100,0,2) + 0.5*x^2\nm <- lm(y~x)\nggplot(data.frame(x=x,y=y), aes(x=x,y=y)) +\n  geom_point() +\n  geom_smooth(formula = y ~ x, method=\"lm\", se=FALSE)\n```\n\nAnd with the residuals shown as red lines:\n\n```{r}\nggplot(data.frame(x=x,y=y), aes(x=x,y=y)) +\n  geom_point() +\n  geom_smooth(formula = y ~ x, method=\"lm\", se=FALSE) +\n  geom_segment(aes(xend=x, yend=m$fitted), color=\"red\")\n```\n\nAt low values of $y$, the residuals are positive, at intermediate values of $y$ the residuals are negative, and at high values of $y$ the residuals are positive. This pattern in the residuals is a sign that the relationship between $x$ and $y$ is not linear.\n\nWe can plot the value of the residuals against the $y$ value directly, instead of looking at the pattern in the graph above. This is called a **Tukey-Anscombe plot**. It is a graph of the residuals versus the fitted $y$ values.\n\n```{r}\nplot(m,which=1)\n```\n\nWe can very clearly see pattern in the residuals in this Tukey-Anscombe plot. The residuals are positive, then negative, then positive, as the fitted $y$ value gets larger.\n\nThe red line in the Tukey-Anscombe plot is a loess smooth. It is automatically added to the plot. It is a way of estimating the pattern in the residuals. If the red line is not flat, then there is a pattern in the residuals. However, the loess smooth is not always reliable. It is a good idea to look at the residuals directly, without this smooth.\n\n```{r}\nplot(m, which=1, add.smooth = FALSE)\n```\n\n\nThe data here is simulated to show a very clear pattern in the residuals. In real data, the pattern might not be so clear. But if you suspect you see a pattern in the residuals, it could be a sign that the relationship between the independent and dependent variable is not linear.\n\nHere is the Tukey-Anscombe plot for the blood pressure data:\n\n```{r}\nplot(bp_age_model, which=1, add.smooth = FALSE)\n```\n\nThere is very little evidence of any pattern in the residuals. This data is simulated with a truly linear relationship, so we would not expect to see any pattern in the residuals.\n\n\n### (e) No outliers\n\nAn outlier is a data point that is very different from the other data points. Outliers can have a big effect on the results of a regression analysis. They can pull the line of best fit towards them, and make the line of best fit a poor representation of the data.\n\nLets again look at the blood pressure versus age data:\n\n```{r}\nggplot(bp_age_model, aes(x = Age, y=Systolic_BP)) +\n  geom_point() +\n  geom_smooth(formula = y ~ x, method=\"lm\", se=FALSE) +\n  xlim(10, 85) +\n  ylim(100, 180)\n```\n\nThere are no obvious outliers in this data. The data points are all close to the line of best fit. This is a good sign that the line of best fit is a good representation of the data.\n\n::: {.callout-tip}\n## Think, Pair, Share\n\nWhere on this graph would you expect to see particularly influential outliers? Influential in the sense that they would have a large effect on the slope of the line of best fit.\n:::\n\nData points that are far from the mean of the independent variable have a large effect on the value of the slope. These data points have a large leverage. They are data points that are far from the other data points in the $x$ direction.\n\nWe can think of this with the analogy of a seesaw. The slope of the line of best fit is like the pivot point of a seesaw. Data points that are far from the pivot point have a large effect on the slope. Data points that are close to the pivot point have a small effect on the slope.\n\nA measure of distance from the pivot point is called the $leverage$ of a data point. In simple regression, the leverage of individual $i$ is defined as\n\n$h_{i} = (1/n) + (x_i-\\overline{x})^2 / SSX$.\n\nwhere\n$SSX = \\sum_{i=1}^n (x_i - \\overline{x})^2$. (**S**um of **S**quares of **$X$**)\n\nSo, the leverage of a data point is inversely related to $n$ (the number of data points). The leverage of a data point is also inversely related to the sum of the squares of the $x$ values. The leverage of a data point is directly related to the square of the distance of the $x$ value from the mean of the $x$ values.\n\nMore intuitively perhaps, the leverage of a data point will be greater when the are fewer other data points. It will also be greater when the distance from the mean value of $x$ is greater.\n\nGoing back to the analogy of a seesaw, with data points as children on the seesaw, the leverage of a data point is like the distance from the pivot a child sits. But we also have children of different weights. A lighter child will have less effect on the tilt of the seesaw. A heavier one will have a greater effect on the tilt. A heavier child sitting far from the pivot will have a very large effect.\n\n\n::: {.callout-tip}\n## Think, Pair, Share\n\nWhat quantity that we already experienced is like the weight of the child?\n:::\n\n\nThe size of the residuals are like the weight of the child. Data points with large residuals have a large effect on the slope of the line of best fit. Data points with small residuals have a small effect on the slope of the line of best fit.\n\nSo the overall effect of a data point on the slope of the line of best fit is a combination of the leverage and the residual. This quantity is called the $influence$ of a data point.\n\nLets add a rather extreme data point to the blood pressure versus age data:\n\n```{r}\nbp_age_model_outlier <- rbind(bp_age_data, data.frame(Age=80, Systolic_BP=120))\nggplot(bp_age_model_outlier, aes(x = Age, y=Systolic_BP)) +\n  geom_point() +\n  geom_smooth(formula = y ~ x, method=\"lm\", se=FALSE) +\n  geom_smooth(formula = y ~ x, data = bp_age_data, method=\"lm\", se=FALSE, color=\"red\") +\n  xlim(10, 85) +\n  ylim(100, 180)\n```\n\nThis is a bit ridiculous, but it is a good example of an outlier. The data point is far from the other data points. It has a large residual. And it is a long way from the pivot (the middle of the $x$ data) so has large leverage.\n\nWe can make a histogram of the residuals and see that the outlier has a large residual:\n\n```{r}\nbp_age_model_outlier <- lm(Systolic_BP ~ Age, data=bp_age_model_outlier)\nggplot(bp_age_model_outlier, aes(x = .resid)) +\n  geom_histogram(bins=10) +\n  geom_vline(xintercept = 0, color=\"red\")\n```\n\nAnd we can see that the leverage is large.\n\nThere is a graph that we can look at to see the influence of a data point. This is called a $Cook's$ $distance$ plot. The Cook's distance of a data point is a measure of how much the slope of the line of best fit changes when that data point is removed. The Cook's distance of a data point is defined as\n\n$D_i = \\sum_{j=1}^n (\\hat{y}_j - \\hat{y}_{j(i)})^2 / (p \\times MSE)$.\n\nwhere\n$\\hat{y}_j$ is the predicted value of the dependent variable for data point $j$,\n$\\hat{y}_{j(i)}$ is the predicted value of the dependent variable for data point $j$ when data point $i$ is removed,\n$p$ is the number of parameters in the model (2 in this case),\n$MSE$ is the mean squared error of the model.\n\n\n```{r}\nplot(bp_age_model_outlier, which=5)\n```\n\nBut does it have a large influence on the value of the slope?\n\n```{r}\nbp_age_data_outlier <- rbind(bp_age_data, data.frame(Age=80, Systolic_BP=120))\nbp_age_model_outlier <- lm(Systolic_BP ~ Age, data=bp_age_data_outlier)\nggplot(bp_age_data_outlier, aes(x = Age, y=Systolic_BP)) +\n  geom_point() +\n  geom_smooth(formula = y ~ x, method=\"lm\", se=FALSE) +\n  geom_smooth(formula = y ~ x, data = bp_age_data, method=\"lm\", se=FALSE, color=\"red\") +\n  xlim(10, 85) +\n  ylim(100, 180)\n```\n\nThe outlier has a large leverage. It is far from the pivot. But it does not have such a large effect (influence) on the slope. This is in large part because there are a lot data points (100) that are quite tightly arranged around the regression line.\n\n\n#### Graphical illustration of the leverage effect\n\nData points with $x_i$ values far from the mean have a stronger leverage effect than when $x_i\\approx \\overline{x}$:\n\n```{r, fig.height=3, fig.width=8}\nset.seed(37489)\npar(mfrow=c(1,3),mar=c(4,4,1,1))\nx <- sort(rnorm(18))\ny <- 2*x + rnorm(18,0,0.4)\nplot(y~x)\nabline(lm(y~x))\ny1 <- y\ny1[18] <- y[18] -5\nplot(y1~x,col=c(rep(1,17),2))\nabline(lm(y~x))\nabline(lm(y1~x),col=2,lty=2)\ny2 <- y\ny2[9] <- y2[9] + 5\nplot(y2~x,col=c(rep(1,8),2,rep(1,9)))\nabline(lm(y~x))\nabline(lm(y2~x),col=2,lty=2)\n```\n\nThe outlier in the middle plot \"pulls\" the regression line in its direction and has large influence on the slope.\n\n\n\n#### Leverage plot (Hebelarm-Diagramm)\n\nIn the leverage plot, (standardized) residuals $\\tilde{R_i}$ are plotted against the leverage $H_{ii}$ :\n\n```{r}\nplot(bp_age_model, which=5, add.smooth = FALSE)\n```\n\nCritical ranges are the top and bottom right corners!!\n\nHere, observations 71, 85, and 87 are labelled as potential outliers.\n\n\nSome texts will give a rule of thumb that points with Cook’s distances greater than 1 should be considered influential, while others claim a reasonable rule of thumb is  $4 / ( n - p - 1 )$\n where $n$ is the sample size, and $p$ is the number of $beta$ parameters.\n\n\n## What can go \"wrong\" during the modeling process?\n\nAnswer: a lot of things!\n\n* Non-linearity. We assumed a linear relationship between the response and the explanatory variables. But this is not always the case in practice. We might find that the relationship is curved and not well represtented by a straight line.\n* Non-normal distribution of residuals. The QQ-plot data might deviate from the straight line so much that we get worried!\n* Heteroscadisticity (non-constant variance). We assumed homoscadisticity, but the residuals might show a pattern.\n* Data point with high influence. We might have a data point that has a large influence on the slope of the line of best fit.\n\n\n### What to do when things \"go wrong\"?\n\n1. Now: Transform the response and/or explanatory variables.\n2. Now: Take care of outliers.\n3. Later in the course: Improve the model, e.g., by adding additional terms or interactions.\n4. Later in the course: Use another model family (generalized or nonlinear regression model).\n\n\n### Dealing with non-linearity\n\nHere's another example of $y$ and $x$ that are not linearly related:\n\n```{r fig.height=4, fig.width=7}\nrequire(tidyverse)\neg_data <- tibble(x = runif(50)) %>%\n  mutate(log_y = log(0.1) + 0.5* log(x) + rnorm(50,0,0.1),\n         y = exp(log_y),\n         log_y = log(y),\n         log_x = log(x),\n         sqrt_y = sqrt(y))\n\np1 <- ggplot(eg_data, aes(x = x, y = y)) +\n  geom_point() + \n  theme_bw() + geom_smooth(formula = y ~ x, method = \"lm\", se = FALSE)\n\nm1 <- lm(y ~ x, eg_data)\n\np2 <- ggplot(mapping = aes(x = fitted(m1), y = residuals(m1))) +\n  geom_point() + theme_bw() +\n  geom_hline(yintercept = 0, linetype = \"dashed\") +\n  geom_smooth(formula = y ~ x, method = \"loess\")\n\n\nlibrary(patchwork)\n\np1 + p2\n```\n\nOne way to deal with this is to transform the response variable $Y$. Here we try two different transformations: $\\log_{10}(Y)$ and $\\sqrt{Y}$.\n\nSquare root transform of the response variable $Y$:\n\n```{r fig.height=7, fig.width=7}\np3 <- ggplot(eg_data, aes(x = x, y = sqrt_y)) +\n  geom_point() + \n  theme_bw() + geom_smooth(formula = y ~ x, method = \"lm\", se = FALSE)\nm2 <- lm(sqrt_y ~ x, eg_data)\np4 <- ggplot(mapping = aes(x = fitted(m2), y = residuals(m2))) +\n  geom_point() + theme_bw() +\n  geom_hline(yintercept = 0, linetype = \"dashed\") +\n  geom_smooth(formula = y ~ x, method = \"loess\")\n\n\n\n(p1 + p2) / (p3 + p4)\n```\n\nNot great.\n\nLog transformation of the response variable $Y$:\n\n```{r fig.height=10.5, fig.width=7}\np5 <- ggplot(eg_data, aes(x = x, y = log_y)) +\n  geom_point() + \n  theme_bw() + geom_smooth(formula = y ~ x, method = \"lm\", se = FALSE)\nm3 <- lm(log_y ~ x, eg_data)\np6 <- ggplot(mapping = aes(x = fitted(m3), y = residuals(m3))) +\n  geom_point() + theme_bw() +\n  geom_hline(yintercept = 0, linetype = \"dashed\") +\n  geom_smooth(formula = y ~ x, method = \"loess\")\n\n(p1 + p2) / (p3 + p4) / (p5 + p6)\n```\n\nNope. Still some evidence of non-linearity.\n\nWhat about transforming the explanatory variable $X$ as well?\n\n```{r fig.height=4, fig.width=7}\np7 <- ggplot(eg_data, aes(x = log_x, y = log_y)) +\n  geom_point() + \n  theme_bw() + geom_smooth(formula = y ~ x, method = \"lm\", se = FALSE)\nm4 <- lm(log_y ~ log_x, eg_data)\np8 <- ggplot(mapping = aes(x = fitted(m4), y = residuals(m4))) +\n  geom_point() + theme_bw() +\n  geom_hline(yintercept = 0, linetype = \"dashed\") +\n  geom_smooth(formula = y ~ x, method = \"loess\")\n\n\np7 + p8\n```\n\n\n\n\nLet's look at the four diagnostic plots for the log-log-transformed data:\n\n```{r out.width=\"7cm\", fig.align='center', echo=FALSE, message=FALSE, warning=FALSE}\npar(mfrow=c(2,2))\nplot(m4)\n```\n\nAll looks pretty good. Pat on the back for us!\n\nBut... how to know which transformation to use...? It's a bit of trial and error. But we can use the diagnostic plots to help us.\n\n**Very very important** is that we do this trial and error before we start using the model. E.g., we don't want to jump from the aeroplane and then find out that our parachute is not working properly! And then try to fix the parachute while we are falling....\n\nLikewise, we must not start using the model and then try to fix it. We need to make sure our model is in good working order before we start using it.\n\nOne of the traps we could fall into is called \"p-hacking\". This is when we try different transformation until we find one that gives us the **result we want**, for example significant relationship. This is a big no-no in statistics. We need to decide on the model (including any transformations) before we start using it.\n\n\n### Common transformations\n\nWhich transformations could be considered? There is no simple answer. But some guidelines. E.g. if we see non-linearity and increasing variance with increasing fitted values, then a log transform may improve matter.\n\nSome common and useful transformations are:\n\n* The log transformation for concentrations and absolute values.\n* The square-root transformation for count data.\n* The arcsin square-root $\\arcsin(\\sqrt{\\cdot})$ transformation for proportions/percentages.\n\nTransformations can also be applied on explanatory variables, as we saw in the example above.\n\n\n\n### Outliers\n\nWhat do we do when we identify the presence of one or more outliers?\n\n1. Start by checking the \"correctness\" of the data. Is there a typo or a decimal point that was shifted by mistake? Check both the response and explanatory variables.\n2. If not, ask whether the model could be improved. Do reasonable transformations of the response and/or explanatory variables eliminate the outlier? Do the residuals have a distribution with a long tail (which makes it more likely that extreme observations occur)?\n3. Sometimes, an outlier may be the most interesting observation in a dataset! Was the outlier created by some interesting but different process from the other data points?\n4. Consider that outliers can also occur just by chance!\n5. Only if you decide to report the results of both scenario can you check if inclusion/exclusion changes the qualitative conclusion, and by how much it changes the quantitative conclusion.\n\n\n### Removing outliers\n\nIt might seem tempting to remove observations that apparently don't fit into the picture. However:\n\n* Do this __only with greatest care__ e.g., if an observation has extremely implausible values!  \n* Before deleting outliers, check points 1-5 above.\n* When removing outliers, **you must mention this in your report**.\n\n\nDuring the course we'll see many more examples of things going at least a bit wrong. And we'll do our best to improve the model, so we can be confident in it, and start to use it. Which we will start to do in the next lesson. But before we wrap up, some good news...\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n## Its a kind of magic... {#sec-kind-of-magic}\n\nAbove, we learned about linear regression, the equation for it, how to estimate the coefficients, and how to check the assumptions. There was a lot of information, and it might seem a bit overwhelming.\n\nYou might also be aware that there are quite a few other types of statistical model, such as multiple regression, t-test, ANOVA, two-way ANOVA, and ANCOVA. It could be worrying to think that you need to learn so much new information for each of these types of tests.\n\nBut this is where the kind-of-magic happens. The good news is that the linear regression model is a special case of what is called a *general linear model*, or just *linear model* for short. And that all the tests mentioned above are also types of *linear model*. So, once you have learned about linear regression, you have learned a lot about linear models, and therefore also a lot about all of these other tests as well.\n\nMoreover, the same function in R 'lm' is used to make all those statistical models Awesome.\n\n### So what is a linear model?\n\nA linear model is a model where the relationship between the dependent variable and the independent variables is linear. That is, the dependent variable can be expressed as a linear combination of the independent variables. An example of a linear model is:\n\n$$y = \\beta_0 + \\beta_1 x_1 + \\beta_2 x_2 + \\ldots + \\beta_p x_p + \\epsilon$$\n\nwhere:\n$y$ is the dependent variable,\n$\\beta_0$ is the intercept,\n$\\beta_1, \\beta_2, \\ldots, \\beta_p$ are the coefficients of the independent variables,\n$x_1, x_2, \\ldots, x_p$ are the independent variables,\n$\\epsilon$ is the error term.\n\n\nIn contrast, a non-linear model is a model where the relationship between the dependent variable and the independent variables is non-linear. An example of a non-linear model is the exponential growth model:\n\n$$y = \\beta_0 + \\beta_1 e^{\\beta_2 x} + \\epsilon$$\n\nwhere:\ny is the dependent variable,\n$\\beta_0$ is the intercept,\n$\\beta_1, \\beta_2$ are the coefficients of the independent variables,\n$x$ is the independent variable,\n$\\epsilon$ is the error term.\n\nKeep in mind that a model with a quadratic term is still a linear model. For example:\n\n$$y = \\beta_0 + \\beta_1 x_1 + \\beta_2 x^2 + \\epsilon$$\n\nis still a linear model. We can see this if we substitute $x^2$ with a new variable $x_2$, where $x_2 = x^2$. The model then becomes:\n\n$$y = \\beta_0 + \\beta_1 x_1 + \\beta_2 x_2 + \\epsilon$$\n\nThis is clearly a linear model.\n\n\n\n## End of L3 / Start of L4\n\n\n## Regression continued\n\n## Overview of this week (L4)\n\nNow that we have a satisfactory model, we can start to use it. In the following material, you will learn:\n\n* How to measure how good is the regression (correlation and $R^2$).\n* How to test if the parameter estimates are compatible with some specific value ($t$-test).\n* How to find the range of parameters values are compatible with the data (confidence intervals).\n* How to find the regression lines compatible with the data (confidence band).\n* How to calculate plausible values of newly collected data (prediction band).\n\n### Accompanying reading material\n\n## How good is the regression model?\n\nWhat would a good regression model look like? What would a bad one look like? One could say that a good regression model is one that explains the dependent variable well. But what could we mean by \"explains the data well\"?\n\nTake these two examples.\n\n```{r fig.width = 7, fig.height = 4}\n## two side by sides graphs, one with a good fit, one with a bad fit\nx <- 1:10\ny1 <- 2*x + rnorm(10,0,1)\ny2 <- 2*x + rnorm(10,0,5)\nm1 <- lm(y1 ~ x)\nm2 <- lm(y2 ~ x)\ny1_predicted <- predict(m1)\ny2_predicted <- predict(m2)\np1 <- ggplot() +\n  geom_point(aes(x=x,y=y1)) +\n  geom_line(aes(x=x,y=y1_predicted)) +\n  theme_minimal()\np2 <- ggplot() +\n  geom_point(aes(x=x,y=y2)) +\n  geom_line(aes(x=x,y=y2_predicted)) +\n  theme_minimal()\np1 + p2\n\n```\n\n\n::: {.callout-tip}\n## Think, Pair, Share\n\nIn which of these two would you say the model is better, and in which is it worse?\n:::\n\n\nThe first model seems to fit the data well, while the second one does not. But how can we quantify this?\n\nLet's say that we will measure the goodness of the model by the amount of variability of the dependent variable that is explained by the independent variable. To do this we need to do the following:\n\n1. Measure the total variability of the dependent variable (total sum of squares, $SST$).\n2. Measure the amount of variability of the dependent variable that is explained by the independent variable (model sum of squares, $SSM$).\n3. Measure the variability of the dependent variable that is not explained by the independent variable (error sum of squares, $SSE$).\n4. Calculate the proportion of variability of the dependent variable that is explained by the independent variable ($R^2$, pronounced as \"r-squared\") (also known as the coefficient of determination) ($R^2$ = $SSM/SST$).\n\n**Importantly, note that we will calculate $SSM$ and $SSE$ so that they sum up to $SST$. I.e., $SST = SSM + SSE$. That is, the total variability is the sum of what is explained by the model and what remains unexplained.**\n\nLet's take each in turn:\n\n### $SST$\n\n**1. The total variability of the dependent variable is the sum of the squared differences between the dependent variable and its mean. This is called the total sum of squares ($SST$).**\n\n$$SST = \\sum_{i=1}^{n} (y_i - \\bar{y})^2$$\n\nwhere:\n$y_i$ is the dependent variable,\n$\\bar{y}$ is the mean of the dependent variable,\n$n$ is the number of observations.\n\n**Note that sometimes $SST$ is referred to as $SSY$ (sum of squares of $y$).**\n\nGraphically, this is the sum of the square of the blue residuals as shown in the following graph, where the horizontal dashed line is at the value of the mean of the dependent variable.\n\n```{r}\nggplot() +\n  geom_hline(yintercept = mean(y1), linetype = \"dashed\") +\n  geom_segment(aes(x=x, y=y1, xend=x, yend=mean(y1)), col = \"blue\", linewidth = 2) +\n  geom_point(aes(x=x,y=y1), size = 5) +\n  theme_minimal()\n```\n\nWe can calculate this in R as follows:\n\n```{r}\n#| echo: true\nSST <- sum((y1 - mean(y1))^2)\n```\n\n### SSM and SSE\n\nNow the next two steps, that is getting the model sum of squares (SSM) and the error sum of squares (SSE) are a bit more complicated. To do this we need to fit a regression model to the data. Let's see this graphically, and divide the data into the explained and unexplained parts.\n\nMake a graph with vertical lines connecting the data to the mean of the data, but with each line two parts, one from the mean to the data, and one from the data to the predicted value.\n\n```{r}\nggplot() +\n  geom_hline(yintercept = mean(y1), linetype = \"dashed\") +\n  geom_segment(aes(x=x, y=y1_predicted, xend=x, yend=mean(y1)), col = \"green\", linewidth = 3) +\n  geom_line(aes(x=x,y=y1_predicted)) +\n  ## show the residuals\n  geom_segment(aes(x=x, y=y1, xend=x, yend=y1_predicted), col = \"red\", linewidth = 1.5) +\n    geom_point(aes(x=x,y=y1), size = 5) +\n  theme_minimal()\n```\n\nIn this graph, the square of the length of the green lines is the model sum of squares ($SST$). The square of the length of the red lines is the error sum of squares ($SSE$).\n\nIn a better model the length of the green lines will be **longer** (the square of these gives the $SMM$, the variability explained by the model). And the length of the red lines will be **shorter** (the square of these gives the $SSE$, the variability not explained by the model).\n\n\n### $SSM$\n\nNext we will do the second step, that is calculate the model sum of squares ($SSM$).\n\n**2. The amount of variability of the dependent variable that is explained by the independent variable is called the model sum of squares ($SSM$).**\n\nThis is the difference between the predicted value of the dependent variable and the mean of the dependent variable, squared and summed:\n\n$$SSE = \\sum_{i=1}^{n} (\\hat{y}_i - \\bar{y})^2$$\n\nwhere:\n$\\hat{y}_i$ is the predicted value of the dependent variable,\n\nIn R, we calculate this as follows:\n\n```{r}\n#| echo: true\nm1 <- lm(y1 ~ x)\ny1_predicted <- predict(m1)\nSSM <- sum((y1_predicted - mean(y1))^2)\nSSM\n```\n\n### $SSE$\n\nThird, we calculate the error sum of squares ($SSE$) with either of two methods. We could calculate it as the sum of the squared residuals, or as the difference between the total sum of squares and the model sum of squares:\n\n$$SSE = \\sum_{i=1}^{n} (y_i - \\hat{y}_i)^2 = SST - SSM$$\nLet's calculate this in R uses both approaches:\n\n```{r}\n#| echo: true\nSSE <- sum((y1 - y1_predicted)^2)\nSSE\n```\n\nOr...\n\n```{r}\n#| echo: true\nSSE <- SST - SSM\nSSE\n```\n\n### $R^2$\n\nFinally, we calculate the proportion of variability of the dependent variable that is explained by the independent variable ($R^2$):    \n\n$$R^2 = \\frac{SSM}{SST}$$\n\n```{r}\nR.squared <- SSM/SST\nR.squared\n```\n\n### Is my R squared good?\n\nWhat value of $R^2$ is considered good? In ecological research, $R^2$ values are often low (less than 0.3), because ecological systems are complex and many factors influence the dependent variable. However, in other fields, such as physiology, $R^2$ values are often higher. Therefore, the answer of what values of $R^2$ are good depends on the field of research.\n\nHere are the four examples and their r-squared.\n\n```{r fig.width = 7, fig.height = 7}\n## Make a graph of x and y1 and the regression line and the r-squared value\nset.seed(1233)\nx <- 1:10\ny1 <- 2*x + rnorm(10,0,1)\ny2 <- 2*x + rnorm(10,0,5)\ny3 <- 2*x + rnorm(10,0,10)\ny4 <- 2*x + rnorm(10,0,20)\nm1 <- lm(y1 ~ x)\nm2 <- lm(y2 ~ x)\nm3 <- lm(y3 ~ x)\nm4 <- lm(y4 ~ x)\nylims <- range(c(y1, y2, y3, y4))\nylims <- c(-30, 50)\np1 <- ggplot(data.frame(x = x, y1 = y1), aes(x = x, y = y1)) +\n  geom_point() +\n  geom_smooth(method = \"lm\", se = FALSE, formula = y ~ x) +\n  geom_text(aes(x = 0, y = -20, label = paste(\"R^2 = \", round(summary(m1)$r.squared, 2))), hjust = 0, vjust = 0) +\n  theme_minimal() +\n  ylim(ylims)\np2 <- ggplot(data.frame(x = x, y2 = y2), aes(x = x, y = y2)) +\n  geom_point() +\n  geom_smooth(method = \"lm\", se = FALSE, formula = y ~ x) +\n  geom_text(aes(x = 0, y = -20, label = paste(\"R^2 = \", round(summary(m2)$r.squared, 2))), hjust = 0, vjust = 0) +\n  theme_minimal() +\n  ylim(ylims)\np3 <- ggplot(data.frame(x = x, y3 = y3), aes(x = x, y = y3)) +\n  geom_point() +\n  geom_smooth(method = \"lm\", se = FALSE, formula = y ~ x) +\n  geom_text(aes(x = 0, y = -20,\n                label = paste(\"R^2 = \", round(summary(m3)$r.squared, 2))),\n            hjust = 0, vjust = 0) +\n  theme_minimal() +\n  ylim(ylims)\np4 <- ggplot(data.frame(x = x, y4 = y4), aes(x = x, y = y4)) +\n  geom_point() +\n  geom_smooth(method = \"lm\", se = FALSE, formula = y ~ x) +\n  geom_text(aes(x = 0, y = -20, label = paste(\"R^2 = \", round(summary(m4)$r.squared, 2))), hjust = 0, vjust = 0) +\n  theme_minimal() +\n  ylim(ylims)\n(p1 + p2) / (p3 + p4)\n```\n\n### Questions\n\n::: {.callout-tip}\n## Think, Pair, Share\n\nWhat is minimised when we fit a regression model? And therefore what is maximised?\n:::\n\n\n## How unlikey is the observed data given the null hypothesis?\n\n(We often hear this expressed as \"is the relationship significant?\")\n\nWhat is a meaningful null hypothesis for a regression model?\n\nOften we are interested in whether there is a relationship between the dependent and independent variable. Therefore, the null hypothesis is that there is no relationship between the dependent and independent variable. This means that the null hypothesis is that the slope of the regression line is zero.\n\nRecall the regression model:\n$$y = \\beta_0 + \\beta_1 x + \\epsilon$$\n\n::: {.callout-tip}\n## Think, Pair, Share\n\nWrite down the null hypothesis of no relationship between $x$ and $y$.\n:::\n\nThe null hypothesis is that the slope of the regression line is zero:\n$$H_0: \\beta_1 = 0$$\n\nWhat is the alternative hypothesis?\n\n$$H_1: \\beta_1 \\neq 0$$\n\nSo, how do we test the null hypothesis?\n\nLet's use randomisation as a method to understand how likely we are to observe the data we have, given the null hypothesis is true.\n\nIf the null hypothesis is true, we expect no relationship between $x$ and $y$. Therefore, we can shuffle the $y$ values and fit a regression model to the shuffled data. We can repeat this many times and calculate the slope of the regression line each time. This will give us a distribution of slopes we would expect to observe if the null hypothesis is true.\n\nFirst, we'll make some data and get the slope of the regression line. Here is the observed slope and relationship:\n\n```{r}\nset.seed(123)\nn <- 100\nx <- 1:n\ny <- 0.1*x + rnorm(n, 0, 10)\nm <- lm(y ~ x)\ncoef(m)[2]\n```\n\n```{r}\nggplot(data.frame(x = x, y = y), aes(x = x, y = y)) +\n  geom_point() +\n  geom_smooth(method = \"lm\", se = FALSE, formula = y ~ x) +\n  theme_minimal()\n```\n\nNow we'll use randomisation to test the null hypothesis. We can create lots of examples where the relationship is expected to have a slope of zero by shuffling randomly the $y$ values. Here are 20:\n\n```{r fig.width=10, fig.height=10}\npar(mfrow = c(5, 4))\nfor (i in 1:20) {\n  y_rand <- sample(y)\n  m_rand <- lm(y_rand ~ x)\n  plot(x, y_rand, main = paste(\"Slope = \", round(coef(m_rand)[2], 2)))\n  abline(m_rand)\n}\n```\n\nNow let's create 19 and put the real one in there somewhere random. Here's a case where the real data has a quite strong relationship:\n\n```{r fig.width=10, fig.height=10}\ny <- 0.5*x + rnorm(n, 0, 15)\npar(mfrow = c(5, 4))\nthis_one <- round(runif(1, 1, 20),0)\nfor (i in 1:20) {\n  if (i == this_one) {\n    plot(x, y, main = paste(i))\n    #abline(m)\n  } else {\n    y_rand <- sample(y)\n    m_rand <- lm(y_rand ~ x)\n    plot(x, y_rand, main = paste(i))\n    #abline(m_rand)\n  }\n}\n\n```\n\nWe can confidently find the real data amont the shuffled data. But what if the relationship is weaker?\n\n```{r fig.width=10, fig.height=10}\ny <- 0.15*x + rnorm(n, 0, 15)\npar(mfrow = c(5, 4))\nthis_one <- round(runif(1, 1, 20),0)\nfor (i in 1:20) {\n  if (i == this_one) {\n    plot(x, y, main = paste(i), ylab = \"y\")\n    #abline(m)\n  } else {\n    y_rand <- sample(y)\n    m_rand <- lm(y_rand ~ x)\n    plot(x, y_rand, main = paste(i), ylab = \"y\")\n    #abline(m_rand)\n  }\n}\n```\n\nNow its less clear which is the real data. We can use this idea to test the null hypothesis.\n\nWe do the same procedure of but instead of just looking at the graphs, we calculate the slope of the regression line each time. This gives us a distribution of slopes we would expect to observe if the null hypothesis is true. We can then see where the observed slope lies in this distribution of null hypothesis slopes.\n\n```{r}\n# repeat 10000 time a randomisation test\ny <- 0.15*x + rnorm(n, 0, 15)\nrand_slopes <- replicate(10000, {\n  y_rand <- sample(y)\n  m_rand <- lm(y_rand ~ x)\n  coef(m_rand)[2]\n})\n\nggplot(data.frame(slopes = rand_slopes), aes(x = slopes)) +\n  geom_histogram(bins = 50) +\n  geom_vline(xintercept = coef(m)[2], color = \"red\") +\n  theme_minimal()\n```\n\nWe can now calculate the probability of observing the data we have, given the null hypothesis is true.\n\n```{r}\np_value <- mean(abs(rand_slopes) >= abs(coef(m)[2]))\np_value\n```\n\nWhen we do linear regression we usually don't use this randomisation approach. Instead, we can use the fact that the the slope of the regression line is an estimate of the true slope. This estimate has uncertainty associated with it. We can use this uncertainty to calculate the probability of observing the data we have, given the null hypothesis is true.\n\nWe can see that the slope estimate (the $x$ row) has uncertainty by looking at the regression output:\n\n```{r}\nsummary(m)$coefficients[1:2, 1:2]\n```\n\nThe estimate is the mean of the distribution of the parameter (slope) and the standard error is a measure of the uncertainty of the estimate.\n\nThe standard error is calculated as:\n\n$$\\sigma^{(\\beta_1)} = \\sqrt{ \\frac{\\hat\\sigma^2}{\\sum_{i=1}^n (x_i - \\bar x)^2}}$$\n\nWhere $\\hat\\sigma^2$ is the expected residual variance of the model. This is calculated as:\n\n$$\\hat\\sigma^2 = \\frac{\\sum_{i=1}^n (y_i - \\hat y_i)^2}{n-2}$$\n\nWhere $\\hat y_i$ is the predicted value of $y_i$ from the regression model.\n\nOK, let's take a look at this intuitively. We have the the estimate of the slope and the standard error of the estimate.\n\nHere is a graph of the value of the slope estimate versus the standard error of the estimate:\n\n```{r}\nslope_estimate_value <- seq(-1, 1, 0.01)\nstandard_error_value <- seq(0.01, 0.5, along = slope_estimate_value)\nggplot(data.frame(slope_estimate = slope_estimate_value,\n                  standard_error = standard_error_value),\n       aes(x = slope_estimate, y = standard_error)) +\n  #geom_line() +\n  theme_minimal()\n```\n\n::: {.callout-tip}\n## Think, Pair, Share\n\nIn what areas of the graph is the slope estimate more likely to have been observed by chance? And what regions is it less likely to have been observed by chance?\n:::\n\n\nWhen the slope estimate is larger, it is less likely to have been observed by chance. And when the standard error is larger, it is more likely to have been observed by chance. How can we put these together into a single measure?\n\nIf we divide the slope estimate by the standard error, we get a measure of how many standard errors the slope estimate is from the null hypothesis slope of zero. This is the $t$-statistic:\n\n$$t = \\frac{\\hat\\beta_1 - \\beta_{1,H_0}}{\\sigma^{(\\beta_1)}}$$\n\nWhere $\\beta_{1,H_0}$ is the null hypothesis value of the slope, usually zero, so that\n\n$$t = \\frac{\\hat\\beta_1}{\\sigma^{(\\beta_1)}}$$\n\n**The $t$-statistic is a measure of how many standard errors the slope estimate is from the null hypothesis value of the slope. The larger the $t$-statistic, the less likely the slope estimate was observed by chance.**\n\nHow can we transform the value of a $t$-statistic into a p-value? We can use the **$t$-distribution**, which quantifies the probability of observing a value of the $t$-statistic under the null hypothesis.\n\nBut what is the $t$-distribution? It is a distribution of the $t$-statistic under the null hypothesis. It is a bell-shaped distribution that is centered on zero. The shape of the distribution is determined by the degrees of freedom, which is $n-2$ for a simple linear regression model.\n\n```{r}\nggplot(data.frame(x = seq(-4, 4, 0.01)), aes(x = x)) +\n  stat_function(fun = dt, args = list(df = 98)) +\n  theme_minimal()\n```\n\n\n\nBy the way, it is named the $t$-distribution by it's developer, William Sealy Gosset, who worked for the Guinness brewery in Dublin, Ireland. In his 1908 paper, Gosset introduced the $t$-distribution but he didn't explicitly explain his choice of the letter $t$. The choice of the letter $t$ could be to indicate \"Test\", as the $t$-distribution was developed specifically for hypothesis testing.\n\nNow, recall that the p-value is the probability of observing the value of the test statistic (so here the $t$-statistic) at least as extreme as the one we have, given the null hypothesis is true. We can calculate this probability by integrating the $t$-distribution from the observed $t$-statistic to the tails of the distribution.\n\nHere is a graph of the $t$-distribution with 100 degrees of freedom with the tails of the distribution shaded so that the area of the shaded region is 0.05 (i.e., 5% of the total area).\n\n\n\n```{r}\nn <- 100\nt_95perc <- qt(0.975, df = n)\ndf <- data.frame(x = seq(-4, 4, 0.01), \n                dt = dt(seq(-4, 4, 0.01), df = n-2))\ndf_95perc_lower <- df[df$x < -t_95perc, ]\ndf_95perc_upper <- df[df$x > t_95perc, ]\nggplot(df, aes(x = x, y = dt)) +\n  geom_line(data = df, mapping = aes(x = x, y = dt)) +\n  geom_area(data = df_95perc_lower,\n            mapping = aes(x = x, y = dt),\n            fill = \"lightblue\") +\n  geom_area(data = df_95perc_upper,\n            mapping = aes(x = x, y = dt),\n            fill = \"lightblue\") +\n  theme_minimal()\n```\n\nGraph of the $t$-distribution with 1000 degrees of freedom (blue line) and the normal distribution (green dashed line):\n\n```{r}\nn <- 5\nggplot(data.frame(x = seq(-4, 4, 0.01)), aes(x = x)) +\n  stat_function(fun = dt, args = list(df = n-2),\n                lwd = 1.5, lty = \"solid\", col = \"blue\") +\n  stat_function(fun = dnorm, args = list(mean = 0, sd = 1),\n                lwd = 1.3, lty = \"solid\", col = \"darkorange\") +\n  theme_minimal()\n```\n\n\nSo, with a large number of observations, the $t$-distribution approaches the normal distribution. For the normal distribution, the 95% area is between -1.96 and 1.96.\n\n```{r}\n#| echo=TRUE\n## x value for 95% area of normal distribution\nx_value <- qnorm(0.975)\nx_value\n```\n\n`qnorm` is a function that calculates the $x$ value for a given quantile (probability) of the normal distribution. In simpler terms, it finds the value $x$ at which the area under the normal curve (up to $x$) equals the given probability  $p$ (0.975 in the example immediately above here).\n\n```{r}\n#| eval = FALSE\nggplot(data.frame(x = seq(-4, 4, 0.01)), aes(x = x)) +\n  stat_function(fun = dnorm, args = list(mean = 0, sd = 1)) +\n  geom_vline(xintercept = x_value, linetype = \"dashed\")\n```\n\n\n\n```{r}\n#| eval = FALSE\nn <- 1000\nggplot(data.frame(x = seq(-4, 4, 0.01)), aes(x = x)) +\n  stat_function(fun = dt, args = list(df = n-2),\n                lwd = 1.5, lty = \"solid\", col = \"blue\") +\n  stat_function(fun = dnorm, args = list(mean = 0, sd = 1),\n                lwd = 1.3, lty = \"solid\", col = \"darkorange\") +\n  theme_minimal()\n```\n\n\nLet's go back to the age - blood pressure data and calculate the p-value for the slope estimate.\n\n```{r}\nbp_data <- read.csv(here::here(\"data/Simulated_Blood_Pressure_and_Age_Data.csv\"))\nggplot(bp_data, aes(x = Age, y = Systolic_BP)) +\n  geom_point() +\n  geom_smooth(method = \"lm\", se = FALSE, formula = y ~ x)\n```\n\nHere's the model:\n\n```{r}\n#| echo = TRUE\nmod1 <- lm(Systolic_BP ~ Age, data = bp_data)\n```\n\nHere we calculate the $t$-statistic for the slope estimate:\n\n```{r}\nt_stat <- mod1$coefficients[2] / summary(mod1)$coefficients[2, 2]\n```\n\nAnd here we calculate the one-tailed and two-tailed $p$-values:\n\n```{r}\none_tailed_p_value <- pt(-abs(t_stat), df = nrow(bp_data) - 2)\ntwo_tailed_p_value <- 2 * one_tailed_p_value\none_tailed_p_value\ntwo_tailed_p_value\n```\n\nWe can get the $p$-value directly from the `summary` function:\n\n```{r}\nsummary(mod1)$coefficients[2, ]\n```\n\n\nConclusion: there is __very strong evidence__ that the blood pressure is associated with age, because the $p$-value is extremely small (thus it is very unlikely that the observed slope value or a large one would be seen if there was really no association). Thus, we can reject the null hypothesis that the slope is zero.\n\nThis basically answers question 1: \"Are the parameters compatible with some specific value?\"\n\n### Recap: Formal definition of the $p$-value\n\n\nThe formal definition of $p$-value is the probability to observe a data summary (e.g., an average or a slope) that is at least as extreme as the one observed, given that the null hypothesis is correct.\n \n\nExample (normal distribution): Assume that we calculated that $t$-value = -1.96  \n\n$\\Rightarrow$ $Pr(|t|\\geq 1.96)=0.05$ and $Pr(t\\leq-1.96)=0.025$.\n\n\n```{r fig.width=8, fig.height=4}\npar(mfrow=c(1,2))\n\nzz1 <- qnorm(0.025)\nzz2 <- qnorm(0.975)\nzz3 <- qnorm(0.025)\n\ncord.x1 <- c(-4,seq(-4,zz1,0.01),zz1)\ncord.y1 <- c(0,dnorm(seq(-4,zz1,0.01)),0)\n\ncord.x2 <- c(zz2,seq(zz2,4,0.01),4)\ncord.y2 <- c(0,dnorm(seq(zz2,4,0.01)),0)\n\ncurve(dnorm(x,0,1),-4,4,ylab=\"density\",main=\"Two-sided p-value (0.05)\",xlab=\"\")\npolygon(cord.x1,cord.y1,col='gray')\npolygon(cord.x2,cord.y2,col='gray')\ntext(-3,0.05,labels=\"2.5%\")\ntext(3,0.05,labels=\"2.5%\")\n\ncord.x3 <- c(-4,seq(-4,zz3,0.01),zz3)\ncord.y3 <- c(0,dnorm(seq(-4,zz3,0.01)),0)\n\ncurve(dnorm(x,0,1),-4,4,ylab=\"density\",main=\"One-sided p-value (0.025)\",xlab=\"\")\npolygon(cord.x3,cord.y3,col='gray')\ntext(-3,0.05,labels=\"2.5%\")\n```\n\n\n\n### A cautionary note on the use of $p$-values\n\nMaybe you have seen that in statistical testing, often the criterion $p\\leq 0.05$ is used to test whether $H_0$ should be rejected. This is often done in a black-or-white manner. However, we will put a lot of attention to a more reasonable and cautionary interpretation of $p$-values in this course! \n\n\n\n## How strong is the relationship?\n\nThe actual value of the parameter has practical meaning. The slope of the regression line tells us how much the dependent variable changes when the independent variable changes by one unit. The slope is one measure of the strength of the relationship between the two variables.\n\nWe can ask what values of a parameter estimate are compatible with the data (confidence intervals)? To answer this question, we can determine the confidence intervals of the regression parameters.\n\nThe confidence interval of a parameter estimate is defined as the interval that contains the true parameter value with a certain probability. So the 95% confidence interval of the slope is the interval that contains the true slope with a probability of 95%.\n\nWe can then imagine two cases. The 95% confidence interval of the slope includes 0:\n\n```{r fig.width=10, fig.height=2}\n## a horizontal line showing the confidence interval overlapping 0\n## only an x-axis\nx <- seq(-1, 1, 0.01)\ny <- rep(0, length(x))\nggplot(data.frame(x = x, y = y), aes(x = x, y = y)) +\n  geom_line(lty = \"dotted\") +\n  geom_errorbarh(aes(y = 0, xmin = -0.1, xmax = 0.5), height = 0.05) +\n  theme_minimal() +\n  theme(axis.title.y = element_blank(),\n        axis.text.y = element_blank(),\n        axis.ticks.y = element_blank()) +\n  #geom_vline(xintercept = c(-1, 1), linetype = \"dashed\") +\n  theme_minimal() +\n  ylim(-0.1, 0.1) +\n  xlim(-1, 1) +\n  ## no y axis\n  theme(axis.title.y = element_blank(),\n        axis.text.y = element_blank(),\n        axis.ticks.y = element_blank())\n```\n\nOr where the confidence interval does not include zero:\n\n```{r fig.width=10, fig.height=2}\n## a horizontal line showing the confidence interval overlapping 0\n## only an x-axis\nx <- seq(-1, 1, 0.01)\ny <- rep(0, length(x))\nggplot(data.frame(x = x, y = y), aes(x = x, y = y)) +\n  geom_line(lty = \"dotted\") +\n  geom_errorbarh(aes(y = 0, xmin = 0.1, xmax = 0.7), height = 0.05) +\n  theme_minimal() +\n  theme(axis.title.y = element_blank(),\n        axis.text.y = element_blank(),\n        axis.ticks.y = element_blank()) +\n  #geom_vline(xintercept = c(-1, 1), linetype = \"dashed\") +\n  theme_minimal() +\n  ylim(-0.1, 0.1) +\n  xlim(-1, 1) +\n  ## no y axis\n  theme(axis.title.y = element_blank(),\n        axis.text.y = element_blank(),\n        axis.ticks.y = element_blank())\n```\n\nHow do we calculate the lower and upper limits of the 95% confidence interval of the slope?\n\nRecall that the $t$-value for a null hypothesis of slope of zero is defined as:\n\n$$t = \\frac{\\hat\\beta_1}{\\hat\\sigma^{(\\beta_1)}}$$\n\nThe first step is to calculate the $t$-value that corresponds to a p-value of 0.05. This is the $t$-value that corresponds to the 97.5% quantile of the $t$-distribution with $n-2$ degrees of freedom.\n\n$t_{0.975} = t_{0.025} = 1.96$, for large $n$.\n\nThe 95% confidence interval of the slope is then given by:\n\n$$\\hat\\beta_1 \\pm t_{0.975} \\cdot \\hat\\sigma^{(\\beta_1)}$$\n\nIn our blood pressure example the estimated slope is `r coef(mod1)[2]` and the standard error of the slope is `r summary(mod1)$coef[2,2]`. We can calculate the 95% confidence interval of the slope as follows:\n\n```{r}\n#| echo = TRUE\nn <- 100\nt_0975 <- qt(0.975, df = n - 2)\nhalf_interval <- t_0975 * summary(mod1)$coef[2,2]\nlower_limit <- coef(mod1)[2] - half_interval\nupper_limit <- coef(mod1)[2] + half_interval\nci_slope <- c(lower_limit, upper_limit)\nslope <- coef(mod1)[2]\nslope\nci_slope\n```\n\nR can do all this for us:\n\n```{r}\n## 95% confidence interval of the slope of mod1\nci_slope_2 <- confint(mod1, level=c(0.95))[2,]\nci_slope_2\n\n```\n\n\nOr we can do it using values from the coefficients table:\n\n```{r echo = TRUE, eval = TRUE}\ncoefs <- summary(mod1)$coef\nbeta <- coefs[2,1]\nsdbeta <- coefs[2,2] \nbeta + c(-1,1) * qt(0.975,241) * sdbeta \n```\n\n\n*Interpretation*: for an increase in the age by one year, roughly 0.82 mmHg increase in blood pressure is expected, and all true values for $\\beta_1$ between 0.77 and 0.88 are compatible with the observed data.\n\n## Confidence and Prediction Bands\n\n* Remember: If another sample from the same population was taken, the regression line would look slightly different.  \n\n* There are two questions to be asked:  \n\n1. Which other regression lines are compatible with the observed data? This leads to the *confidence band*.\n \n2. Where do future observations ($y$)  with a given $x$ coordinate lie? This leads to the *prediction band*.\n\n\nNote: The prediction band is much broader than the confidence band.\n\n## Calculation of the confidence band\n\nGiven a fixed value of $x$, say $x_0$. The question is: \n\n\nWhere does $\\hat y_0 = \\hat\\beta_0 + \\hat\\beta_1 x_0$ lie with a certain confidence (i.e., 95%)? \n\n\nThis question is not trivial, because both $\\hat\\beta_0$ and $\\hat\\beta_1$ are estimates from the data and contain uncertainty. \n\nThe details of the calculation are given in Stahel 2.4b. \n\nPlotting the confidence interval around all $\\hat y_0$ values one obtains the *confidence band* or *confidence band for the expected values* of $y$.\n\nNote: For the confidence band, only the uncertainty in the estimates $\\hat\\beta_0$ and $\\hat\\beta_1$ matters.\n\nHere is the confidence band for the blood pressure data:\n\n```{r}\n## calculate the confidence band for the expected values of y\nnew_data <- data.frame(Age = seq(20, 80, by = 1))\nconf_band <- cbind(new_data,\n                   predict(mod1, newdata = new_data, interval = \"confidence\", level = 0.95))\nggplot(bp_age_data, aes(x = Age, y = Systolic_BP)) +\n  geom_point() +\n  geom_line(aes(y = fit), data = conf_band, color = \"purple\", lwd = 1) +\n  geom_ribbon(aes(ymin = lwr, ymax = upr, y = fit), data = conf_band, alpha = 0.3) +\n  labs(title = \"Confidence band for the expected values of y\",\n       subtitle = \"95% confidence band\",\n       x = \"Age\", y = \"Systolic BP\")\n  \n```\n\nVery narrow confidence bands indicate that the estimates are very precise. In this case the estimated intercept and slope are precise because the sample size is large and the data points are close to the regression line.\n\n\n\n\n\n\n```{r eval=FALSE, fig.width=5,fig.height=5, out.width='7cm', echo = FALSE, fig.align='center'}\nt.range <- range(bp_data$Systolic_BP)\nt.xwerte <- seq(t.range[1]-1,t.range[2]+1,by=1)\nt.vert <- predict(mod1,se.fit=T,newdata=data.frame(bmi=t.xwerte),\ninterval =\"confidence\")$fit\nt.vorh <- predict(mod1,se.fit=T,newdata=data.frame(bmi=t.xwerte),\ninterval =\"prediction\")$fit\nplot(bp_data$Systolic_BP,d.bodyfat$bodyfat,main=\"Confidence band\",xlab=\"BMI\",ylab=\"bodyfat\",xlim=range(t.xwerte),ylim=c(-5,50),cex=0.8)\nabline(mod1,lwd=2)\nlines(x=t.xwerte,y=t.vert[,2],lty=8,lwd=2,col=2)\nlines(x=t.xwerte,y=t.vert[,3],lty=8,lwd=2,col=2)\nlegend(\"bottomright\", c(\"confidence band (95%)\"),\nlty=8, cex=1,col=c(2),lwd=2)\n```\n\n\n## Calculations of the prediction band\n\nWe can easily predicted an expected value of $y$ for a given $x$ value. But we can also ask w where does a *future observation* lie with a certain confidence (i.e., 95\\%)?\n\nTo answer this question, we have to *consider not only the uncertainty in the predicted value caused by uncertainty in the parameter estimates* $\\hat y_0 =  \\hat\\beta_0 + \\hat\\beta_1 x_0$, but also the *error term* $\\epsilon_i \\sim N(0,\\sigma^2)$}.  \n\nThis is the reason why the **prediction band** is wider than the confidence band.\n\nHere's a graph showing the prediction band for the blood pressure data:\n\n```{r}\nprediction_band <- cbind(new_data,\n                   predict(mod1, newdata = new_data, interval = \"prediction\", level = 0.95))\nggplot(bp_age_data, aes(x = Age, y = Systolic_BP)) +\n  geom_point() +\n  geom_line(aes(y = fit), data = prediction_band, color = \"blue\", lwd = 1) +\n  geom_ribbon(aes(ymin = lwr, ymax = upr, y = fit), data = prediction_band, alpha = 0.3, fill = \"green\") +\n  geom_ribbon(aes(ymin = lwr, ymax = upr, y = fit), data = conf_band, alpha = 0.3,\n              fill = \"purple\") +\n  labs(title = \"Prediction band for future observations (green)\\nand confidence band for expected values (purple)\",\n       x = \"Age\", y = \"Systolic BP\")\n```\n\nAnother way to think of the 95% confidence band is that it is where we would expect 95% of the regression lines to lie if we were to collect many samples from the same population. The 95% prediction band is where we would expect 95% of the future observations to lie.\n\n## That is regression done (at least for our current purposes)\n\n* Why use (linear) regression?\n* Fitting the line (= parameter estimation)\n* Is linear regression good enough model to use?\n* What to do when things go wrong?\n* Transformation of variables/the response.\n* Handling of outliers.\n* Goodness of the model: Correlation and $R^2$\n* Tests and confidence intervals\n* Confidence and prediction bands\n\n\n## Additional reading material\n\nIf you'd like another perspective and a deeper delve into some of the mathematical details, please look at Chapter 2 of _Lineare Regression_, p.7-20 (Stahel script), Chapters 3.1, 3.2a-q of *Lineare Regression*,\nand Chapters 4.1 4.2f, 4.3a-e of *Lineare Regression*\n\n\n\n","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":5,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":false,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"center","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"3-regression.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.433","theme":"cosmo"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}