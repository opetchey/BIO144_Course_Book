<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Count data (L8) – BIO144 Course Book (version 2026)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./9.1-GLM2-binary-data.html" rel="next">
<link href="./7.1-interactions.html" rel="prev">
<link href="./cover.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-485d01fc63b59abcd3ee1bf1e8e2748d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./8.1-GLM1-count-data.html">Count data (L8)</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">BIO144 Course Book (version 2026)</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/opetchey/BIO144_Course_Book/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1.1-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction (L1)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2.1-R-and-RStudio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R and RStudio (L2)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3.1-regression-part1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regression Part 1 (L3)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./4.1-regression-part2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regression Part 2 (L4)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./5.1-anova.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analysis of variance (L5)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./6.1-multiple-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multiple regression (L6)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./7.1-interactions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interactions (L7)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./8.1-GLM1-count-data.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Count data (L8)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./9.1-GLM2-binary-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Binary data (L9)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10.1-ordination.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ordination (L10)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11.1-mixed-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mixed models (L11-1)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11.2-what-next.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">What next (L11-2)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12.1-review.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Review (L12)</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#example-soay-sheep" id="toc-example-soay-sheep" class="nav-link" data-scroll-target="#example-soay-sheep">Example: Soay sheep</a>
  <ul class="collapse">
  <li><a href="#the-wrong-analysis" id="toc-the-wrong-analysis" class="nav-link" data-scroll-target="#the-wrong-analysis">The wrong analysis</a></li>
  <li><a href="#why-linear-regression-fails-for-count-data" id="toc-why-linear-regression-fails-for-count-data" class="nav-link" data-scroll-target="#why-linear-regression-fails-for-count-data">Why linear regression fails for count data</a></li>
  </ul></li>
  <li><a href="#from-lm-to-glm" id="toc-from-lm-to-glm" class="nav-link" data-scroll-target="#from-lm-to-glm">From LM to GLM</a></li>
  <li><a href="#poisson-glm" id="toc-poisson-glm" class="nav-link" data-scroll-target="#poisson-glm">Poisson GLM</a>
  <ul class="collapse">
  <li><a href="#parameter-estimation" id="toc-parameter-estimation" class="nav-link" data-scroll-target="#parameter-estimation">Parameter estimation</a></li>
  </ul></li>
  <li><a href="#r---poisson-glm" id="toc-r---poisson-glm" class="nav-link" data-scroll-target="#r---poisson-glm">R - Poisson GLM</a>
  <ul class="collapse">
  <li><a href="#checking-model-assumptions" id="toc-checking-model-assumptions" class="nav-link" data-scroll-target="#checking-model-assumptions">Checking model assumptions</a></li>
  <li><a href="#interpreting-coefficients" id="toc-interpreting-coefficients" class="nav-link" data-scroll-target="#interpreting-coefficients">Interpreting coefficients</a></li>
  <li><a href="#analysis-of-deviance" id="toc-analysis-of-deviance" class="nav-link" data-scroll-target="#analysis-of-deviance">Analysis of deviance</a></li>
  <li><a href="#reporting" id="toc-reporting" class="nav-link" data-scroll-target="#reporting">Reporting</a></li>
  </ul></li>
  <li><a href="#well-done" id="toc-well-done" class="nav-link" data-scroll-target="#well-done">Well done!</a></li>
  <li><a href="#overdispersion" id="toc-overdispersion" class="nav-link" data-scroll-target="#overdispersion">Overdispersion</a>
  <ul class="collapse">
  <li><a href="#quasi-poisson-and-negative-binomial-models" id="toc-quasi-poisson-and-negative-binomial-models" class="nav-link" data-scroll-target="#quasi-poisson-and-negative-binomial-models">Quasi-Poisson and negative binomial models</a></li>
  </ul></li>
  <li><a href="#zero-inflation" id="toc-zero-inflation" class="nav-link" data-scroll-target="#zero-inflation">Zero inflation</a></li>
  <li><a href="#multiple-explanatory-variables" id="toc-multiple-explanatory-variables" class="nav-link" data-scroll-target="#multiple-explanatory-variables">Multiple explanatory variables</a></li>
  <li><a href="#review" id="toc-review" class="nav-link" data-scroll-target="#review">Review</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading">Further reading</a></li>
  <li><a href="#extras" id="toc-extras" class="nav-link" data-scroll-target="#extras">Extras</a>
  <ul class="collapse">
  <li><a href="#deviance-residuals" id="toc-deviance-residuals" class="nav-link" data-scroll-target="#deviance-residuals">Deviance residuals</a></li>
  <li><a href="#pseudo-r-squared-for-glms" id="toc-pseudo-r-squared-for-glms" class="nav-link" data-scroll-target="#pseudo-r-squared-for-glms">Pseudo-R-squared for GLMs</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/opetchey/BIO144_Course_Book/edit/main/8.1-GLM1-count-data.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/opetchey/BIO144_Course_Book/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Count data (L8)</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In all the previous chapters, we have focused on <strong>linear models</strong>. These are suitable for continuous response variables that can, mathematically, take negative values. However, response variables can be otherwise. For example, we might have a response variable that is the number of offspring produced by a mother. This is a <em>count</em> type of response variable. In this chapter, you’ll see why the models we used so far are usually inappropriate for count data. Then you’ll learn about a more appropriate type of model: <strong>Generalized Linear Models (GLMs)</strong>.</p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>So far in BIO144, we have focused on <strong>linear models</strong> fitted using <code>lm()</code>. These models assume:</p>
<ul>
<li>A <strong>continuous response variable</strong> that can take any real value.</li>
<li>Normally distributed residuals.</li>
<li>Constant variance (homoscedasticity).</li>
</ul>
<p>Linear models are powerful, but these assumptions can be violated in biological data. In this chapter we move beyond linear models to handle an important new type of response variable: <strong>counts</strong>. We introduce <strong>Generalized Linear Models (GLMs)</strong>, which extend linear models by allowing the response variable to follow distributions other than the normal distribution.</p>
<p>By the end of this chapter, you should be able to:</p>
<ul>
<li>Recognise when linear regression is inappropriate</li>
<li>Understand the core components of a GLM</li>
<li>Fit and interpret Poisson regression models</li>
<li>Diagnose common problems such as overdispersion and zero inflation</li>
</ul>
<!---
**Think–Pair–Share** (#tps-non-neg-kinds) What kinds of biological outcomes (response variables) can you think of that *cannot* be negative or continuous?
--->
</section>
<section id="example-soay-sheep" class="level2">
<h2 class="anchored" data-anchor-id="example-soay-sheep">Example: Soay sheep</h2>
<p>A feral population of Soay sheep on the island of Hirta (Scotland) has been studied extensively. Ecologists were interested in whether the <strong>body mass of female sheep</strong> influences their fitness, measured as <strong>lifetime reproductive success</strong> (number of offspring produced over a lifetime).</p>
<p><strong>Question:</strong> Are heavier females fitter than lighter females?</p>
<p>Read in an example dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>soay <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"datasets/soay_sheep.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the first few rows of the dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(soay)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  body.size fitness
1  53.99529      12
2  32.69467       0
3  33.55580       2
4  43.20078       2
5  43.34102       4
6  59.52711       7</code></pre>
</div>
</div>
<p>As always, we start by exploring the data visually:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="8.1-GLM1-count-data_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<!---
**Think–Pair–Share** (#tps-what-suspicious) What features of this plot might already make you suspicious about using linear regression?
--->
<section id="the-wrong-analysis" class="level3">
<h3 class="anchored" data-anchor-id="the-wrong-analysis">The wrong analysis</h3>
<p>Let’s analyse the data with linear regression, treating counts as if they were continuous.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>mod_soay_lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(fitness <span class="sc">~</span> body.size, <span class="at">data =</span> soay)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The model checking plots show clear violations of linear regression assumptions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mod_soay_lm, <span class="at">which =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">add.smooth =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="8.1-GLM1-count-data_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>The qq-plot looks ok-ish, though the larger residuals show a tendency to be larger than expected. The scale-location plot shows that variance increases with fitted values, violating homoscedasticity. Also, there is a clear non-linear pattern in the residuals vs fitted plot, suggesting that the linear model is not capturing the relationship well.</p>
<p>When we plot the fitted line, we see the linear relationship:</p>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="8.1-GLM1-count-data_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<!--
Think-pair-share Other than non-linearity, heteroscedasticity, what other problems can you see with this linear model for count data? Answer: negative predicted values -- negative number of offspring!
--->
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Why this matters</strong><br>
Violating model assumptions can lead to biased estimates, incorrect standard errors, and misleading p-values.</p>
</div>
</div>
<p>Another issue remains, however: linear regression can predict negative counts, which are impossible. We can see this in a plot of the data and the fitted regression line.</p>
</section>
<section id="why-linear-regression-fails-for-count-data" class="level3">
<h3 class="anchored" data-anchor-id="why-linear-regression-fails-for-count-data">Why linear regression fails for count data</h3>
<ul>
<li>The normal distribution is for continuous variables.</li>
<li>It allows negative values.</li>
<li>It assumes constant variance.</li>
</ul>
<!---
**Think–Pair–Share (#a_why_poisson)** Why is a normal distribution a poor choice for count data? Which assumptions can be expected to fail?
--->
<p>However, many biological response variables are:</p>
<ul>
<li><strong>Counts</strong> (e.g.&nbsp;offspring, parasites, species)</li>
<li><strong>Binary responses</strong> (e.g.&nbsp;alive/dead)</li>
<li><strong>Proportions</strong></li>
</ul>
<p>In these cases, forcing the data into a linear model often leads to invalid predictions and misleading inference. <strong>Generalized Linear Models (GLMs)</strong> solve this problem.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Key idea</strong> GLMs are not a replacement for linear models — they are a <em>generalisation</em> of them. Linear regression is a special case of a GLM.</p>
</div>
</div>
<!---
**Think–Pair–Share** (#tps-which-reg-assump) Which assumption of linear regression do you think is most problematic for count data?
--->
</section>
</section>
<section id="from-lm-to-glm" class="level2">
<h2 class="anchored" data-anchor-id="from-lm-to-glm">From LM to GLM</h2>
<p><strong>A linear model is actually a special case of a generalized linear model.</strong></p>
<p>What you already know: in a linear model we write:</p>
<p><span class="math display">\[y_i = \beta_0 + \beta_1 x_i^{(1)} + \cdots + \beta_p x_i^{(p)} + \epsilon_i, \quad \epsilon_i \sim N(0, \sigma^2)\]</span></p>
<p>In words, this means an observed response variable <span class="math inline">\(y_i\)</span> is modelled as a linear combination of explanatory variables plus normally distributed error.</p>
<p>This implies that</p>
<p><span class="math display">\[y_i \sim N(\mu_i, \sigma^2)\]</span></p>
<p>where <span class="math inline">\(\mu_i\)</span> is the mean of the normal distribution for observation <span class="math inline">\(i\)</span>, and</p>
<p><span class="math display">\[\mu_i = \beta_0 + \beta_1 x_i^{(1)} + \cdots + \beta_p x_i^{(p)}\]</span></p>
<p>Moving to things you don’t know:</p>
<p>A generalised linear model has three components: a random component (<em>family</em>), a systematic component (<em>linear predictor</em>), and a link function. In a linear model (like the ones you already saw), these are as follows:</p>
<ul>
<li><strong>Random component (family)</strong>: Normal distribution <span class="math inline">\(N(\mu_i, \sigma^2)\)</span></li>
<li><strong>Systematic component (linear predictor)</strong>: <span class="math inline">\(\eta_i = \beta_0 + \beta_1 x_i^{(1)} + \cdots + \beta_p x_i^{(p)}\)</span></li>
<li><strong>Link function</strong>: Identity link, <span class="math inline">\(\mu_i = \eta_i\)</span>. So the link function is <span class="math inline">\(g(\mu_i) = \mu_i\)</span> – that is, the identity link.</li>
</ul>
<p>Putting this all together in a description of a generalised linear model we have:</p>
<p><strong>Family</strong>: <span class="math inline">\(y_i \sim N(\mu_i, \sigma^2)\)</span></p>
<p><strong>Linear predictor</strong>: <span class="math inline">\(g(\mu_i) = \eta_i = \beta_0 + \beta_1 x_i^{(1)} + \cdots + \beta_p x_i^{(p)}\)</span></p>
<p><strong>Link function</strong>: <span class="math inline">\(g(\mu_i) = \mu_i\)</span></p>
<p>In R, we use the function <code>glm()</code> to fit generalised linear models. For a normal linear model of the Soay sheep data, we would write:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>mod_soay_glm <span class="ot">&lt;-</span> <span class="fu">glm</span>(fitness <span class="sc">~</span> body.size, <span class="at">data =</span> soay, <span class="at">family =</span> <span class="fu">gaussian</span>(<span class="at">link =</span> <span class="st">"identity"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here we have specified the family as Gaussian (i.e., Normal) with an identity link. This model produces the same results as the linear model we fitted earlier with <code>lm()</code>. And we can get the following model summary:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_soay_glm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = fitness ~ body.size, family = gaussian(link = "identity"), 
    data = soay)

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -5.16768    0.68895  -7.501  2.9e-11 ***
body.size    0.21163    0.01501  14.097  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for gaussian family taken to be 4.805055)

    Null deviance: 1425.8  on 99  degrees of freedom
Residual deviance:  470.9  on 98  degrees of freedom
AIC: 444.73

Number of Fisher Scoring iterations: 2</code></pre>
</div>
</div>
<p>Compare that to the linear model summary:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_soay_lm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = fitness ~ body.size, data = soay)

Residuals:
    Min      1Q  Median      3Q     Max 
-4.9760 -1.5468 -0.2568  0.9733  6.3887 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -5.16768    0.68895  -7.501  2.9e-11 ***
body.size    0.21163    0.01501  14.097  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 2.192 on 98 degrees of freedom
Multiple R-squared:  0.6697,    Adjusted R-squared:  0.6664 
F-statistic: 198.7 on 1 and 98 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>The coefficients table is exactly the same. Other parts of the output differ slightly because <code>glm()</code> uses maximum likelihood estimation (MLE) while <code>lm()</code> uses least squares estimation. Put that aside for now; the key point is that both R functions fit the same model when using a normal family with an identity link.</p>
<p>So, you now know what is a generalised linear model. In one sentence it is a model where the response variable follows a specified distribution (family), the mean of that distribution is linked to a linear combination of explanatory variables (linear predictor) via a link function. We will now look at a specific type of GLM for count data: the Poisson GLM.</p>
</section>
<section id="poisson-glm" class="level2">
<h2 class="anchored" data-anchor-id="poisson-glm">Poisson GLM</h2>
<p>We need three components for a GLM: 1. A probability distribution (family) for the response variable. 2. A linear predictor. 3. A link function relating the linear predictor to the mean of the distribution.</p>
<p>Let’s start with a discussion of the probability distribution (family) for count data. And what we’re aiming for is a probability distribution that we expect to be a reasonably good starting point for modelling count data. A common probability model for counts is the <strong>Poisson distribution</strong>. The Poisson distribution is often the default starting point for modelling counts because it is the simplest distribution that respects characteristics of count data: discreteness, non-negativity, and increasing variance.</p>
<p>Unlike the normal distribution, which has two parameters (mean and spread), the Poisson distribution has only one parameter: the mean <span class="math inline">\(\lambda\)</span>. In the Poisson distribution, the mean and variance are equal.</p>
<p>In a Poisson distribution, the probability of observing a count <span class="math inline">\(y\)</span> is given by:</p>
<p><span class="math inline">\(P(Y = y) = \frac{\lambda^y e^{-\lambda}}{y!}\)</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(Y\)</span> is a random variable representing the count.</li>
<li><span class="math inline">\(y = 0, 1, 2, \ldots\)</span></li>
<li><span class="math inline">\(\lambda &gt; 0\)</span> is the mean (and variance) of the distribution.</li>
</ul>
<p>In R, we can get the probability of observing a count of 3, when the expected count is 5, using the <code>dpois()</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dpois</span>(<span class="dv">3</span>, <span class="at">lambda =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1403739</code></pre>
</div>
</div>
<p>And we expect the probability of observing a count of 5 when the expected count is 5 to be higher:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dpois</span>(<span class="dv">5</span>, <span class="at">lambda =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1754674</code></pre>
</div>
</div>
<p>What happens when we ask for the probability of observing a count of 3.5 when the expected count is 5? Or a count of -1?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dpois</span>(<span class="fl">3.5</span>, <span class="at">lambda =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in dpois(3.5, lambda = 5): non-integer x = 3.500000</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
<p>The warning message tells us that the Poisson distribution is only defined for non-negative integers. This is a key property of the Poisson distribution: it is only defined for counts (0, 1, 2, …).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dpois</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="at">lambda =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
<p>And we see that the probability of observing a negative count is zero.</p>
<p>Here are a few of Poisson distributions with different means:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="8.1-GLM1-count-data_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>The Poisson distribution has two important properties:</p>
<ol type="1">
<li>It is defined only for <strong>non-negative integers</strong> (0, 1, 2, …)</li>
<li>The <strong>mean and variance are equal</strong>.</li>
</ol>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Mean–variance relationship</strong><br>
In a Poisson distribution, the mean and variance are equal. This captures an important feature of count data, but it will later lead to the concept of <em>overdispersion</em>.</p>
</div>
</div>
<!---
**Think–Pair–Share** (#a_mean_variance_link) Why does increasing variance with the mean cause problems for linear regression?
--->
<p><strong>So, in a Poisson GLM we assume a Poisson distribution (family) for the response variable.</strong></p>
<p><span class="math display">\[y_i \sim \text{Poisson}(\mu_i)\]</span></p>
<p>where <span class="math inline">\(\mu_i = \lambda_i\)</span> is the expected count for observation <span class="math inline">\(i\)</span>.</p>
<p>Next we need to define the linear predictor (and then we finish with the link function).</p>
<p>The linear predictor is the same as in linear regression:</p>
<p><span class="math inline">\(\eta_i = \beta_0 + \beta_1 x_i^{(1)} + \cdots + \beta_p x_i^{(p)}\)</span></p>
<p>It is just the linear combination of explanatory variables and coefficients. Nothing new here.</p>
<p>Finally, we need to define the link function that relates the linear predictor to the expected count <span class="math inline">\(\mu_i\)</span>.</p>
<p>We cannot use the identity link here, because that would allow negative expected counts. Instead, we use the <strong>log link</strong>:</p>
<p><span class="math display">\[\eta_i = \log(\mu_i)\]</span></p>
<p>which implies:</p>
<p><span class="math inline">\(\mu_i = \exp(\eta_i)\)</span></p>
<p>The log link ensures that the expected count is always positive, regardless of the values of the <span class="math inline">\(\beta\)</span> parameters and explanatory variables. Whatever the value of the linear predictor <span class="math inline">\(\eta_i\)</span>, the exponential of it <span class="math inline">\(\exp(\eta_i)\)</span> is always positive.</p>
<p>Putting this all together, a Poisson GLM can be summarised as:</p>
<p><strong>Family</strong>: <span class="math inline">\(y_i \sim \text{Poisson}(\mu_i)\)</span></p>
<p><strong>Linear predictor</strong>: <span class="math inline">\(\eta_i = \beta_0 + \beta_1 x_i^{(1)} + \cdots + \beta_p x_i^{(p)}\)</span></p>
<p><strong>Link function</strong>: <span class="math inline">\(\log(\mu_i) = \eta_i\)</span></p>
<p>We could also write this as:</p>
<p><span class="math display">\[y_i \sim \mathrm{Poisson}\!\left(\exp\!\left(\beta_0 + \beta_1 x_i^{(1)} + \cdots + \beta_p x_i^{(p)}\right)\right)\]</span></p>
<section id="parameter-estimation" class="level3">
<h3 class="anchored" data-anchor-id="parameter-estimation">Parameter estimation</h3>
<p>We observe the counts <span class="math inline">\(y_i\)</span>, and the model predicts the expected counts <span class="math inline">\(\mu_i\)</span>. The GLM estimates the parameters <span class="math inline">\(\beta_0, \beta_1, \ldots, \beta_p\)</span> that make the observed data most probable under the assumed Poisson model. This is done using maximum likelihood estimation (MLE). The likelihood of the data given the model is maximised.</p>
<p>Recall that we saw that the summary information of the linear model and the GLM with normal family and identity link were different. This is because of differences in estimation methods (least squares vs MLE). In GLMs, we always use MLE for parameter estimation. In this course we will not go into the mathematical details of MLE, but the key idea is that we find parameter values that make the observed data most probable under the assumed model. This is analogous to least squares estimation in linear models, which is a special case of MLE for Normally distributed errors.</p>
</section>
</section>
<section id="r---poisson-glm" class="level2">
<h2 class="anchored" data-anchor-id="r---poisson-glm">R - Poisson GLM</h2>
<p>When fitting a Poisson GLM in R, we use the <code>glm()</code> function, specifying the family as <code>poisson</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>soay_glm <span class="ot">&lt;-</span> <span class="fu">glm</span>(fitness <span class="sc">~</span> body.size, <span class="at">data =</span> soay, <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Specifying <code>family = poisson</code> tells R to use the Poisson distribution with a log link function by default. We also specify the link explicitly as <code>link = "log"</code>. You will, however, often only see <code>family = poisson</code> and not the log link, because the log link is the default for the Poisson family.</p>
<section id="checking-model-assumptions" class="level3">
<h3 class="anchored" data-anchor-id="checking-model-assumptions">Checking model assumptions</h3>
<p>As always, we should check model assumptions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(soay_glm, <span class="at">which =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">add.smooth =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="8.1-GLM1-count-data_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>The QQ-plot is rather concerning. However, QQ-plots in GLMs are not testing normality of residuals in the same way as for linear models, so their interpretation differs. The <em>deviance residuals</em> should approximately follow a normal distribution if the model fits well. Here, there are some deviations from normality, which could be somewhat concerning, but for now we will focus on the other plots. (If you’re interested in what are deviance residuals, please see the <em>Extras</em> section at the end of this chapter.)</p>
<p>The other plots look much better than for the linear model. The residuals vs fitted plot shows no obvious pattern, and the scale-location plot shows more constant variance.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>You must specify the <strong>family</strong> in <code>glm()</code>. If you omit the link function, R uses the default link for that family.</p>
</div>
</div>
</section>
<section id="interpreting-coefficients" class="level3">
<h3 class="anchored" data-anchor-id="interpreting-coefficients">Interpreting coefficients</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(soay_glm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = fitness ~ body.size, family = poisson(link = "log"), 
    data = soay)

Coefficients:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -1.253092   0.210186  -5.962 2.49e-09 ***
body.size    0.053781   0.003735  14.400  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 333.105  on 99  degrees of freedom
Residual deviance:  97.783  on 98  degrees of freedom
AIC: 378.16

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p>Coefficients are estimated on the <strong>log scale</strong>.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>A one-unit increase in an explanatory variable multiplies the expected count by <span class="math inline">\(\exp(\beta)\)</span>.</p>
</div>
</div>
<!---
**Think–Pair–Share** (#tps-what-change-beta) If $\beta=0.05$ what change in the expected count would be caused by an increase in body mass of 1 kg? As well as a numeric value, specify whether it is used additively or multiplicatively.
--->
<p>To interpret the coefficient for body size (<span class="math inline">\(\beta_1 = 0.05\)</span>), we exponentiate it: <span class="math inline">\(\exp(0.05) \approx 1.65\)</span></p>
<p>This means that for each additional kilogram of body size, the expected count of fitness increases by a factor of approximately 1.65 (i.e., a 65% increase). We use the number multiplicatively because of the log link function.</p>
<p>To make a prediction of the expected count for a given body size, we back-transform the linear predictor:</p>
<p><span class="math inline">\(E(y) = \exp(\beta_0 + \beta_1 \times \text{body.size})\)</span></p>
<p>For example, for a body size of 40 kg:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>body_size_example <span class="ot">&lt;-</span> <span class="dv">40</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>linear_predictor <span class="ot">&lt;-</span> <span class="fu">coef</span>(soay_glm)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">coef</span>(soay_glm)[<span class="dv">2</span>] <span class="sc">*</span> body_size_example</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>expected_count <span class="ot">&lt;-</span> <span class="fu">exp</span>(linear_predictor)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>expected_count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept) 
   2.455011 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Although counts can only be integers, the expected value from a Poisson model can be any positive real number. This is because the expected value is a mean over many possible counts.</p>
</div>
</div>
</section>
<section id="analysis-of-deviance" class="level3">
<h3 class="anchored" data-anchor-id="analysis-of-deviance">Analysis of deviance</h3>
<p>There is something technically different that we have glossed over until now: how model fit is assessed. In linear regression we estimate parameters by minimizing the sum of squared residuals. In GLMs, we use <strong>maximum likelihood estimation (MLE)</strong>. In this course we will not go into the mathematical details of MLE, but the key idea is that we find the parameter values that make the observed data most probable under the assumed model (just like in least squares). Instead of minimising sums of squares, we maximise the <strong>likelihood</strong> of the data given the model. Maximising the likelihood is equivalent to minimising the <strong>deviance</strong>, which is a measure of model fit based on likelihoods. Hence, when we fit a GLM in R, we get output including the <strong>deviance</strong> (and not sums of squares):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(soay_glm, <span class="at">test =</span> <span class="st">"Chisq"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Deviance Table

Model: poisson, link: log

Response: fitness

Terms added sequentially (first to last)

          Df Deviance Resid. Df Resid. Dev  Pr(&gt;Chi)    
NULL                         99     333.11              
body.size  1   235.32        98      97.78 &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>In the output we see the deviance for the null model and the fitted model, as well as the change in deviance when adding explanatory variables. We can use a chi-squared test to assess whether adding explanatory variables significantly improves model fit.</p>
<p>We use a chi-squared test here because, under certain regularity conditions, the change in deviance between nested models follows a chi-squared distribution with degrees of freedom equal to the difference in the number of parameters. If you are interested in what this means, you can read more about it in more advanced statistics textbooks.</p>
<p>You may be wondering if we can calculate an r-squared value for GLMs. While there is no direct equivalent of r-squared for GLMs, several pseudo-r-squared measures have been proposed. However, these are not as widely used or interpreted as r-squared in linear regression. If you’re interested, check out the <em>Extras</em> section at the end of this chapter for more information.</p>
</section>
<section id="reporting" class="level3">
<h3 class="anchored" data-anchor-id="reporting">Reporting</h3>
<p>When reporting results from a Poisson GLM, we can make a graph and a sentence describing the pattern and related statistics.</p>
<p>When we wish to make a graph of the fitted relationship, we can either make it with the y-axis on the log scale (linear predictor scale) or back-transform to the original count scale. I usually prefer the original scale, as it is easier to interpret.</p>
<p>The first step is to create a new data frame with a sequence of body sizes for prediction, and errors for the 95% confidence intervals:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>new_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">body.size =</span> <span class="fu">seq</span>(<span class="fu">min</span>(soay<span class="sc">$</span>body.size), <span class="fu">max</span>(soay<span class="sc">$</span>body.size), <span class="at">length.out =</span> <span class="dv">100</span>))</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(soay_glm, <span class="at">newdata =</span> new_data, <span class="at">se.fit =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>new_data<span class="sc">$</span>fit <span class="ot">&lt;-</span> <span class="fu">exp</span>(predictions<span class="sc">$</span>fit)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>new_data<span class="sc">$</span>lower <span class="ot">&lt;-</span> <span class="fu">exp</span>(predictions<span class="sc">$</span>fit <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> predictions<span class="sc">$</span>se.fit)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>new_data<span class="sc">$</span>upper <span class="ot">&lt;-</span> <span class="fu">exp</span>(predictions<span class="sc">$</span>fit <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> predictions<span class="sc">$</span>se.fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that we back-transform the predictions and confidence intervals using the exponential function, since the link function is the log. And note that we must calculate the confidence intervals on the log scale first, and then back-transform them.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If we only wanted the fitted value (and not confidence intervals) we could have used <code>type = "response"</code> in the <code>predict()</code> function to get predictions on the original count scale (back-transformed from the log scale). When we don’t specified this, we would get predictions on the log scale–this is the default behavior.</p>
</div>
</div>
<p>Now we can plot the data and the fitted relationship with confidence intervals:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="8.1-GLM1-count-data_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>Excellent! We can now write a nice sentence for our results:</p>
<p>Reproductive fitness (in terms of lifetime number of offspring) increased significantly with body mass, with a unit increase in body mass associated with a multiplicative increase in expected fitness of 1.06 (95% CI: 1.05, 1.06; <span class="math inline">\(\chi^2 =\)</span> 235.32, <span class="math inline">\(df = 1\)</span>, <span class="math inline">\(p &lt;\)</span> 4.1^{-53}).</p>
</section>
</section>
<section id="well-done" class="level2">
<h2 class="anchored" data-anchor-id="well-done">Well done!</h2>
<p>We have made our first steps into the world of GLMs and Poisson regression for count data. You should now be able to:</p>
<ul>
<li>Recognise why linear regression is often inappropriate for count data.</li>
<li>Understand the components of a GLM: linear predictor, link function, and family.</li>
<li>Fit a Poisson GLM in R using <code>glm()</code>.</li>
<li>Interpret coefficients from a Poisson GLM.</li>
</ul>
<p>Next, we will look at common issues that arise when fitting Poisson models, such as overdispersion and zero inflation.</p>
</section>
<section id="overdispersion" class="level2">
<h2 class="anchored" data-anchor-id="overdispersion">Overdispersion</h2>
<p>In a Poisson model, mean and variance are assumed equal. In practice, variance often exceeds the mean, a phenomenon called <strong>overdispersion</strong>.</p>
<p>Common causes include:</p>
<ul>
<li>Unmeasured explanatory variables. This means important explanatory variables are missing from the model, leading to extra variability.</li>
<li>Individual heterogeneity. This can arise when individuals differ in ways not captured by measured explanatory variables, leading to extra variability in counts.</li>
<li>Correlated observations. This can occur when observations are not independent, such as repeated measures on the same individual.</li>
</ul>
<p>A simple check for overdispersion is to compare the residual deviance to the residual degrees of freedom:</p>
<p><span class="math inline">\(\text{Dispersion} = \frac{\text{Residual Deviance}}{\text{Residual DF}}\)</span></p>
<p>If this ratio is substantially greater than 1 (e.g., &gt; 1.5 or 2), it indicates overdispersion.</p>
<p>Check this for our Soay sheep model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>dispersion_soay <span class="ot">&lt;-</span> <span class="fu">deviance</span>(soay_glm) <span class="sc">/</span> <span class="fu">df.residual</span>(soay_glm)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>dispersion_soay</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9977877</code></pre>
</div>
</div>
<p>Here, the dispersion is quite close to 1 (it is 1), indicating little overdispersion. However, in many real datasets, overdispersion is common.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>Ignoring overdispersion leads to <strong>anti-conservative p-values</strong> (too small). This would be a typical example of <strong>Type I error inflation</strong>. Type I errors occur when we incorrectly reject a true null hypothesis, leading to false positives. In the context of statistical modeling, ignoring overdispersion can result in underestimating standard errors, which in turn leads to smaller p-values. Consequently, we may conclude that an effect is statistically significant when it is not, thereby increasing the likelihood of Type I errors.</p>
</div>
</div>
<!---
**Think–Pair–Share** (#tps-why-ind-diff) Why might individuals differ even after accounting for measured explanatory variables?
--->
<section id="quasi-poisson-and-negative-binomial-models" class="level3">
<h3 class="anchored" data-anchor-id="quasi-poisson-and-negative-binomial-models">Quasi-Poisson and negative binomial models</h3>
<p>One solution is the <strong>quasi-Poisson</strong> model, which estimates an additional dispersion parameter:</p>
<p>For this, we can use <code>family = quasipoisson</code> in <code>glm()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>soay_quasi <span class="ot">&lt;-</span> <span class="fu">glm</span>(fitness <span class="sc">~</span> body.size, <span class="at">data =</span> soay, <span class="at">family =</span> quasipoisson)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(soay_quasi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = fitness ~ body.size, family = quasipoisson, data = soay)

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -1.253092   0.209446  -5.983 3.59e-08 ***
body.size    0.053781   0.003722  14.450  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for quasipoisson family taken to be 0.992977)

    Null deviance: 333.105  on 99  degrees of freedom
Residual deviance:  97.783  on 98  degrees of freedom
AIC: NA

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<!---
**Think–Pair–Share** (#a_overdispersion_consequences) What happens to standard errors and p-values if overdispersion is ignored?
--->
</section>
</section>
<section id="zero-inflation" class="level2">
<h2 class="anchored" data-anchor-id="zero-inflation">Zero inflation</h2>
<p>A special case of overdispersion arises when there are <strong>more zeros than expected</strong> under a Poisson model. This is called <strong>zero inflation</strong>.</p>
<p>Examples include:</p>
<ul>
<li>Number of cigarettes smoked (many people do not smoke, more than can be modelled by a Poisson distribution)</li>
<li>Parasite counts (many host individual have no parasites, more than can be modelled by a Poission distribution)</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Zero inflation often reflects <strong>two processes</strong>: whether an observation can be non-zero at all, and how large it is if it is. E.g., whether an individual smokes at all, and then how many cigarettes they smoke if they do.</p>
</div>
</div>
<!---
**Think–Pair–Share** (#tps-zero-inf-examples) Can you think of an ecological, biological, or medical process that would generate many structural zeros?
--->
<p>In this course we will not describe in detail or practice fitting zero-inflated models, but they are an important tool for count data with many zeros. Examples of models include zero-inflated Poisson (ZIP) and zero-inflated negative binomial (ZINB) models. These models combine a count model (e.g., Poisson or negative binomial) with a separate model for the probability of being a structural zero. There is also a model called the <strong>hurdle model</strong>, which is similar but has a different interpretation.</p>
</section>
<section id="multiple-explanatory-variables" class="level2">
<h2 class="anchored" data-anchor-id="multiple-explanatory-variables">Multiple explanatory variables</h2>
<p>GLMs can include multiple explanatory variables, just like linear models. And they can include only categorical variables, only continuous variables, or a mix of both.</p>
<p>For example, we could include parasite load as an additional predictor of fitness in the Soay sheep data:</p>
<p>Read in the updated dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>soay <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"datasets/soay_sheep_with_parasites.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the first few rows of the updated dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(soay)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  body.size fitness parasite.load
1  53.99529       1             2
2  32.69467       1             6
3  33.55580       0             5
4  43.20078       1             6
5  43.34102       0             7
6  59.52711       3             6</code></pre>
</div>
</div>
<p>We can visualise the relationship between parasite load and fitness:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="8.1-GLM1-count-data_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<p>It looks like higher parasite loads are associated with lower fitness.</p>
<p>We can fit a Poisson GLM with both body size and parasite load as explanatory variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>soay_glm2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(fitness <span class="sc">~</span> body.size <span class="sc">+</span> parasite.load, <span class="at">data =</span> soay, <span class="at">family =</span> poisson)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As always we check model assumptions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(soay_glm2, <span class="at">which =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">add.smooth =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="8.1-GLM1-count-data_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>The model checking plots look good. We can summarise the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(soay_glm2, <span class="at">test =</span> <span class="st">"Chisq"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Deviance Table

Model: poisson, link: log

Response: fitness

Terms added sequentially (first to last)

              Df Deviance Resid. Df Resid. Dev  Pr(&gt;Chi)    
NULL                             99     226.57              
body.size      1   95.723        98     130.85 &lt; 2.2e-16 ***
parasite.load  1   11.063        97     119.78 0.0008809 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>We see that both body size and parasite load significantly affect fitness. Body size has a positive effect, while parasite load has a negative effect. These effects are interpreted conditional on the other explanatory variable being held constant, just as in multiple linear regression.</p>
<!---
**Think–Pair–Share** (#tps-how-vis-poisson) How would you visualise (make a graph) of the data and the modelled relationships? Make a sketch of what you could do.
--->
</section>
<section id="review" class="level2">
<h2 class="anchored" data-anchor-id="review">Review</h2>
<p>In this chapter we have introduced Generalized Linear Models (GLMs) for count data, focusing on Poisson regression. Key points include:</p>
<ul>
<li>Linear regression is often inappropriate for count data due to violations of assumptions.</li>
<li>GLMs extend linear models by allowing different distributions and link functions.</li>
<li>Poisson GLMs use the Poisson distribution with a log link to model counts.</li>
<li>Coefficients are interpreted on the log scale, with exponentiation giving multiplicative effects.</li>
<li>Overdispersion and zero inflation are common issues that need to be addressed.</li>
<li>GLMs can include multiple explanatory variables, just like linear models.</li>
</ul>
<p>With this foundation, you are now equipped to analyse count data using GLMs in R. In the next chapter, we will explore further extensions and applications of GLMs.</p>
</section>
<section id="further-reading" class="level2">
<h2 class="anchored" data-anchor-id="further-reading">Further reading</h2>
<ul>
<li>Chapter 14 of <em>The R Book</em> by Crawley (2012) provides a comprehensive introduction to GLMs in R, including Poisson regression. The R is a bit old fashioned but the concepts are well explained.</li>
<li>Generalized Linear Models With Examples in R (2018) by Peter K. Dunn and Gordon K. Smyth.</li>
</ul>
</section>
<section id="extras" class="level2">
<h2 class="anchored" data-anchor-id="extras">Extras</h2>
<section id="deviance-residuals" class="level3">
<h3 class="anchored" data-anchor-id="deviance-residuals">Deviance residuals</h3>
<p>In linear models, residuals are simply the difference between observed and predicted values. In GLMs, residuals are more complex due to the non-normal distribution of the response variable.</p>
<p>Recall from above that a Poisson GLM is mathematically summarised as:</p>
<p><span class="math inline">\(y_i \sim \text{Poisson}(\lambda_i)\)</span></p>
<p>where <span class="math inline">\(\log(\lambda_i) = \beta_0 + \beta_1 x_i^{(1)} + \cdots + \beta_p x_i^{(p)}\)</span></p>
<p>The <strong>deviance residuals</strong> are a type of residual used in GLMs to assess model fit. They are derived from the concept of deviance, which measures the difference between the fitted model and a saturated model (a model that perfectly fits the data).</p>
<p>The deviance residual for each observation is calculated as: <span class="math inline">\(r_i = \text{sign}(y_i - \hat{y}_i) \sqrt{2 \left( y_i \log\left(\frac{y_i}{\hat{y}_i}\right) - (y_i - \hat{y}_i) \right)}\)</span></p>
<p>where: - <span class="math inline">\(y_i\)</span> is the observed count - <span class="math inline">\(\hat{y}_i\)</span> is the predicted count from the model</p>
<p>Deviance residuals have the following properties:</p>
<ul>
<li>They are approximately normally distributed if the model fits well. <strong>Therefore they can be used in QQ-plots to assess model fit.</strong></li>
<li>They can be positive or negative, indicating whether the observed count is above or below the predicted</li>
<li>They are used in diagnostic plots to assess model fit, similar to residuals in linear models.</li>
</ul>
</section>
<section id="pseudo-r-squared-for-glms" class="level3">
<h3 class="anchored" data-anchor-id="pseudo-r-squared-for-glms">Pseudo-R-squared for GLMs</h3>
<p>While there is no direct equivalent of r-squared for GLMs, several pseudo-r-squared measures have been proposed. These measures aim to provide an indication of model fit similar to r-squared in linear regression, but they do not have the same interpretation.</p>
<p>To understand how pseudo-r-squared works, we first need to understand the concept of deviance and log-likelihoods in GLMs. Deviance is a measure of model fit based on likelihoods. It compares the fitted model to a null model (a model with only an intercept) and a saturated model (a model that perfectly fits the data). Let’s break that down a bit further:</p>
<p><strong>Residual deviance</strong> is calculated as:</p>
<p><span class="math inline">\(D = -2 \left( \log L(\text{fitted model}) - \log L(\text{saturated model}) \right)\)</span></p>
<p>where - <span class="math inline">\(\log L(\text{fitted model})\)</span> is the log-likelihood of the fitted model and - <span class="math inline">\(\log L(\text{saturated model})\)</span> is the log-likelihood of the saturated model.</p>
<p>The log-likelihood measures how well the model explains the observed data; higher values indicate better fit. The fitted model is the model we have estimated, while the saturated model is a hypothetical model that perfectly fits the data.</p>
<p><strong>Null deviance</strong> is calculated similarly, but for the null model:</p>
<p><span class="math inline">\(D_{null} = -2 \left( \log L(\text{null model}) - \log L(\text{fitted model}) \right)\)</span></p>
<p>where - <span class="math inline">\(\log L(\text{null model})\)</span> is the log-likelihood of the null model.</p>
<p>(By the way, the -2 factor is included to make the deviance comparable to the chi-squared distribution, with degrees of freedom equal to the difference in the number of parameters between models. This is useful for hypothesis testing.)</p>
<p>So:</p>
<ul>
<li><strong>Null deviance</strong>: This is the deviance of the null model, which includes only an intercept. It represents how well a model with no predictors fits the data.</li>
<li><strong>Residual deviance</strong>: This is the deviance of the fitted model. It represents how well the model with predictors fits the data relative to the null model.</li>
</ul>
<p>One common pseudo-r-squared measure is McFadden’s R-squared, defined as:</p>
<p><span class="math inline">\(R^2_{McFadden} = 1 - \frac{D_{fitted}}{D_{null}}\)</span> where <span class="math inline">\(D_{fitted}\)</span> is the residual deviance of the fitted model and <span class="math inline">\(D_{null}\)</span> is the null deviance.</p>
<p>This measure ranges from 0 to 1, with higher values indicating better model fit. However, it is important to note that pseudo-r-squared values for GLMs are generally lower than r-squared values in linear regression, and they should be interpreted with caution.</p>
<p>There is much more to learn about the methods surrounding GLMs and their diagnostics, but this introduction should give you a solid foundation to start working with count data in R using Poisson regression.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/opetchey\.github\.io\/BIO144_Course_Book\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./7.1-interactions.html" class="pagination-link" aria-label="Interactions (L7)">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Interactions (L7)</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./9.1-GLM2-binary-data.html" class="pagination-link" aria-label="Binary data (L9)">
        <span class="nav-page-text">Binary data (L9)</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>BIO144 Data Analysis for Biologists, Course Book written by Owen Petchey</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/opetchey/BIO144_Course_Book/edit/main/8.1-GLM1-count-data.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/opetchey/BIO144_Course_Book/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>This book was built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>




</body></html>